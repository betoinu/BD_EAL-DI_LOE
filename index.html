<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOE Challenge: Eskuduntzen Kontrol-panela</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            padding: 0;
        }
        .card {
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.1s;
            border-radius: 6px;
            /* Default card style, overridden by specific classes */
            border-left: 5px solid #6b7280; /* gray-500 */
        }
        .card:active {
            cursor: grabbing;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .drop-zone {
            min-height: 150px;
            border: 3px dashed #d1d5db;
            transition: all 0.2s;
        }
        .drop-zone.active {
            border-color: #10b981;
            background-color: #ecfdf5;
            transform: scale(1.02);
        }
        .defense-card {
            border-left: 5px solid #3b82f6; /* blue-500 */
        }
        .limit-card {
            border-left: 5px solid #ef4444; /* red-500 */
        }
        .scenario-solved-correct {
            background-color: #059669 !important; /* Tailwind green-600 */
            border: 3px solid #10b981; /* Tailwind emerald-500 */
        }
        .scenario-solved-incorrect {
            background-color: #dc2626 !important; /* Tailwind red-600 */
            border: 3px solid #f87171; /* Tailwind red-400 */
        }
        /* Custom scrollbar for better look */
        .card-container {
            max-height: 400px; /* Limit height for scroll */
            overflow-y: auto;
        }
        .card-container::-webkit-scrollbar {
            width: 8px;
        }
        .card-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- HEADER (Shared between Student and Teacher) -->
        <header class="text-center mb-6 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800" data-translate="appTitle">LOE Challenge: BDren Bideragarritasuna</h1>
            <p class="text-gray-600 mt-2" data-translate="appSubtitle">Probatu zure eskuduntzak Udal Berrikuspen Mahaian.</p>
            
            <div id="user-info-bar" class="mt-4 text-sm text-gray-500 border-t pt-2 hidden">
                <p><span class="font-bold">Erabiltzaile Identifikazioa:</span> <span id="student-id-display" class="font-mono text-sm text-blue-600"></span></p>
                <button onclick="document.location.reload()" class="ml-4 text-xs text-red-500 hover:text-red-700 font-medium">
                    (<span data-translate="logoutButton">Saioa Amaitu</span>)
                </button>
            </div>
        </header>

        <!-- PANTALLA 0: HIZKUNTZA ETA AUTENTIFIKAZIOA -->
        <div id="auth-area" class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10">
            <h2 class="text-3xl font-extrabold text-blue-800 mb-6 text-center">LOE Challenge</h2>
            
            <!-- Hizkuntza Aukeraketa -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-700 mb-3 text-center">Aukeratu Hizkuntza / Elige Idioma</h3>
                <div class="flex justify-center space-x-4">
                    <button onclick="window.currentLang='eu'; window.updateTexts(); window.showLoginForm('eu');" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
                        Euskara
                    </button>
                    <button onclick="window.currentLang='es'; window.updateTexts(); window.showLoginForm('es');" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
                        Castellano
                    </button>
                </div>
            </div>

            <!-- Formulário EU -->
            <div id="login-form-eu" class="hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4" data-translate="loginTitle">Plataformarako Sarbidea</h3>
                <p class="text-gray-600 mb-6" data-translate="loginHint">Sartu zure NANa, matrikula-zenbakia, edo izena progresioari hasiera emateko.</p>
                
                <input type="text" id="user-id-input" placeholder="Sartu hemen zure IDa (Irakaslea ere bada)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">
                
                <button onclick="window.handleLogin(window.currentLang)" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150" data-translate="loginButton">
                    Sartu
                </button>
                <p id="auth-message-eu" class="text-red-500 text-sm mt-3"></p>
            </div>
            
            <!-- Formulário ES (Oculto por defecto) -->
            <div id="login-form-es" class="hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4" data-translate="loginTitle">Acceso a la Plataforma</h3>
                <p class="text-gray-600 mb-6" data-translate="loginHint">Introduce tu DNI, número de matrícula o nombre.</p>
                
                <input type="text" id="user-id-input-es" placeholder="Introduce aquí tu ID (también Profesor)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">
                
                <button onclick="window.handleLogin(window.currentLang)" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150" data-translate="loginButton">
                    Acceder
                </button>
                <p id="auth-message-es" class="text-red-500 text-sm mt-3"></p>
            </div>
        </div>

        <!-- PANTALLA 1: IRAKASLEAREN KONTROL-PANELA (DASHBOARD) -->
        <div id="dashboard-area" class="hidden mt-6 bg-white p-8 rounded-xl shadow-2xl">
            <h2 id="teacher-dashboard-title" class="text-3xl font-extrabold text-purple-700 mb-2">Irakaslearen Kontrol-panela</h2>
            <p id="teacher-dashboard-subtitle" class="text-gray-600 mb-6">Ikasle guztien eskuduntza-erronken progresioa. (IDa: <span id="teacher-id-display" class="font-mono font-bold"></span>)</p>

            <button onclick="window.loadAllStudentProgress()" id="update-progress-button" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 mb-4">
                Progresioa Eguneratu
            </button>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
                    <thead class="bg-gray-100">
                        <tr>
                            <th id="student-id-header" class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Ikasle IDa</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">A</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">B</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">C</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">D</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">E</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">F</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">G</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">H</th>
                            <th id="total-correct-header" class="p-3 text-center text-sm font-extrabold text-purple-700 uppercase tracking-wider bg-purple-200">Total Zuzena</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-table-body" class="divide-y divide-gray-200">
                        <!-- Datuak hemen kargatuko dira -->
                    </tbody>
                </table>
            </div>
            
            <button onclick="document.location.reload()" id="teacher-logout-button" class="mt-6 px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                Saioa Amaitu
            </button>
        </div>


        <!-- PANTALLA 2: IKASLE JOKOA (GAME MAIN CONTENT) -->
        <div id="game-main-content" class="hidden">

            <main>
                <!-- SECCIÓN 1: SELECCIÓN DEL ESCENARIO -->
                <div id="scenario-selection" class="mb-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4" data-translate="selectScenarioTitle">1. Agertokia Aukeratu</h2>
                    <div id="scenario-buttons" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Los botones de escenario se generan aquí -->
                    </div>
                    <div id="current-scenario-display" class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-md hidden">
                        <p class="font-semibold text-yellow-800"><span data-translate="activeScenario">Agertoki Aktiboa</span>: <span id="scenario-title" class="font-bold"></span></p>
                        <p id="scenario-description" class="text-sm text-yellow-700"></p>
                    </div>
                </div>

                <!-- SECCIÓN 2: DEFENSA Y ZONA DE JUEGO -->
                <div id="game-area" class="mt-10 hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4" data-translate="mountDefenseTitle">2. Zure Defentsa Muntatu (Arrastatu eta Askatu)</h2>

                    <div class="grid lg:grid-cols-3 gap-8">
                        <!-- Columna 1: Cartas de Concepto LOE -->
                        <div class="lg:col-span-1 bg-white p-4 rounded-xl shadow-md card-container">
                            <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2" data-translate="conceptCardsTitle">LOE Kontzeptu Txartelak</h3>
                            <div id="concept-cards" class="flex flex-wrap gap-2">
                                <!-- Las cartas de concepto se generan aquí -->
                            </div>
                        </div>

                        <!-- Columna 2: Zona de Defensa -->
                        <div class="lg:col-span-1 bg-gray-50 p-6 rounded-xl shadow-inner drop-zone" id="defense-zone">
                            <h3 class="text-xl font-semibold text-blue-700 mb-3" data-translate="defenseZoneTitle">BDren Defentsa Eremua</h3>
                            <p class="text-gray-500 text-sm" data-translate="defenseZoneHint">Arrastatu hona Barnealdeen Diseinatzailearen eskuduntza justifikatzen duten 2 edo 3 kontzeptuak.</p>
                        </div>

                        <!-- Columna 3: Zona de Límites / Ataque -->
                        <div class="lg:col-span-1 bg-red-50 p-6 rounded-xl shadow-inner drop-zone" id="limit-zone">
                            <h3 class="text-xl font-semibold text-red-700 mb-3" data-translate="limitZoneTitle">Udalaren Mugak eta Erasoak</h3>
                            <p class="text-gray-500 text-sm" data-translate="limitZoneHint">Arrastatu hona eskuduntza baliogabetu edo muga dezaketen kontzeptuak.</p>
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                        <button id="check-button" onclick="window.checkScenario()" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 disabled:opacity-50" disabled data-translate="checkButtonText">
                            Eskuduntza Bideragarritasuna Egiaztatu
                        </button>
                    </div>
                </div>

                <!-- SECCIÓN 3: RESULTADO Y RETROALIMENTACIÓN -->
                <div id="result-feedback" class="mt-10 p-6 rounded-xl shadow-xl hidden">
                    <h2 id="result-title" class="text-3xl font-extrabold mb-3"></h2>
                    <div id="result-message" class="text-lg mb-4"></div>
                    <div id="solution-details" class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400">
                        <h3 class="font-bold text-gray-700 mb-2" data-translate="solutionTitle">Lege Justifikazioa eta Estrategia:</h3>
                        <ul id="strategy-list" class="list-disc list-inside text-gray-700"></ul>
                    </div>
                    <button onclick="window.resetGame()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-translate="newChallengeButton">
                        Erronka Berria
                    </button>
                </div>
            </main>
        </div>
    </div>

    <!-- FIREBASE AND GAME LOGIC SCRIPT (Type: module to handle imports) -->
    <script type="module">
        // Firebase Imports (using the specific version URLs for compatibility)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL STATE ---
window.firebase = {
    app: null,
    db: null,
    auth: null,
    studentId: null, 
    appId: 'loe-challenge-game', // ← NOMBRE ÚNICO PARA TU APP
    progress: {},
    role: 'NONE',
    isFirebaseReady: false
};

        window.currentLang = 'eu'; // Idioma por defecto antes de la selección inicial
        window.currentScenarioId = null; 
        
        const TEACHER_KEY = "IRAKASLEA"; 
        const firebaseConfig = {
    apiKey: "AIzaSyB5jzbVWMiEzUPB2aTWfF6BbE-cf7aKvRE",
    authDomain: "nire-github-proiektua.firebaseapp.com",
    projectId: "nire-github-proiektua",  // ← Este debería ser tu projectId
    storageBucket: "nire-github-proiektua.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef123456"
};

        // --- RAW DATA (Scenarios and Concepts) ---
        const rawData = {
            scenarios: [
                { id: 'A', solution: 'COLABORACIÓN NECESARIA', 
                    es: { title: 'A. El Cerramiento de Balcón (Volumen)', summary: 'Cerrar un balcón con estructura ligera y vidrio, aumentando la superficie útil interior.', strategy: ['**Límite Urbanístico (Alteración del Volumen):** El aumento de la superficie habitable o construida obliga a revisar el coeficiente de edificabilidad, lo que empuja el proyecto a Obra Mayor o requiere la firma de un Arquitecto/Técnico para el cálculo volumétrico.', '**Estrategia DI:** El DI puede hacer el diseño, pero debe colaborar con un técnico superior para la validación urbanística y volumétrica ante el municipio.']}, 
                    eu: { title: 'A. Balkoiaren Itxitura (Bolumena)', summary: 'Balkoi bat egitura arinez eta beiraz ixtea, barruko azalera erabilgarria handituz.', strategy: ['**Hirigintza Muga (Bolumenaren Aldaketa):** Bizigarri den edo eraikitako azaleraren handitzeak eraikigarritasun koefizientea berrikustea dakar. Horrek proiektua Obra Nagusira bultzatzen du edo Arkitekto/Teknikari baten sinadura eskatzen du kalkulu bolumetrikoa egiteko.', '**BD Estrategia:** BDk diseinua egin dezake, baina udalerriaren aurrean hirigintza eta bolumen balioztapeneko goi mailako teknikari batekin lankidetzan aritu behar du.']}
                },
                { id: 'B', solution: 'ID COMPETENTE', 
                    es: { title: 'B. El Cambio de Uso Mayor (Ermita a Kafe Antzokia)', summary: 'Rehabilitar una ermita del S. XIX para un Kafe Antzokia (uso de pública concurrencia). No se toca estructura.', strategy: ['**Especialización Funcional:** El objeto principal es la **Adecuación Funcional** del espacio y el diseño interior (aforo, distribución, estética), lo cual es competencia de la DI.', '**Uso de Recinto:** El DI es plenamente competente para garantizar el cumplimiento de **DB-SUA (Seguridad de Uso)** y **DB-SI (Incendio)** dentro del recinto, demostrando la **Modificación NO Esencial**.', '**Colaboración:** Solo sería necesario un Arquitecto para la consolidación estructural o si la normativa de Bienes Culturales lo exige, pero el DI lidera la adecuación del uso.']}, 
                    eu: { title: 'B. Erabilera Aldaketa Nagusia (Ermitatik Kafe Antzokira)', summary: 'XIX. mendeko ermita bat Kafe Antzoki (jendaurreko erabilera) baterako birgaitzea. Egiturarik ez da ukitzen.', strategy: ['**Espezializazio Funtzionala:** Helburu nagusia espazioaren **Egokitzapen Funtzionala** eta barne diseinua da (edukiera, banaketa, estetika), eta hori BDren eskuduntza da.', '**Esparru Erabilera:** BD erabat eskuduna da **DB-SUA (Erabilera Segurtasuna)** eta **DB-SI (Sutea)** betetzen direla bermatzeko, **Ezinbestekoa EZ den Aldaketa** dela frogatuz.', '**Lankidetza:** Arkitekto bat egituraren sendotzeagatik edo Kultur Ondasunen araudiak hala eskatzen badu bakarrik beharko litzateke, baina BDk gidatzen du erabileraren egokitzapena.']}
                },
                { id: 'C', solution: 'ID COMPETENTE', 
                    es: { title: 'C. La Segregación de Vivienda', summary: 'Dividir una vivienda grande en dos más pequeñas. Implica tirar tabiques no portantes y duplicar instalaciones de recinto.', strategy: ['**Volumetría Neutra:** Es una obra **volumétricamente neutra** (no es Obra Mayor). El límite es el urbanismo (superficie mínima), no la obra en sí.', '**Especialización en Habitabilidad:** El DI es el técnico competente para demostrar la **Garantía de Habitabilidad** (DB-HS: ventilación, iluminación, superficie mínima) de las nuevas unidades.', '**Instalaciones de Recinto:** La duplicación de contadores/sub-contadores es **Instalación de Recinto** (Punto III), competencia directa del DI, sin afectar la acometida fija principal.']}, 
                    eu: { title: 'C. Etxebizitzaren Segregazioa', summary: 'Etxebizitza handi bat bi txikiagotan zatitzea. Egiturazkoak ez diren tabikeak bota eta esparruko instalazioak bikoiztea dakar.', strategy: ['**Bolumetria Neutroa:** **Bolumen aldetik neutroa** den obra da (ez da Obra Nagusia). Muga hirigintza da (gutxieneko azalera), ez obra bera.', '**Bizigarritasun Espezializazioa:** BD da unitate berrien **Bizigarritasunaren Bermea** (DB-HS: aireztapena, argiztapena, gutxieneko azalera) frogatzeko teknikari eskuduna.', '**Esparruko Instalazioak:** Kontagailuak/azpi-kontagailuak bikoiztea **Esparruko Instalazioa** da (III. puntua), BDren eskuduntza zuzena, hartune finko nagusiari eragin gabe.']}
                },
                { id: 'D', solution: 'COLABORACIÓN NECESARIA', 
                    es: { title: 'D. El Desafío de Instalaciones (Discoteca)', summary: 'Adecuación de local para Discoteca. Requiere insonorización pasiva y un potente sistema de climatización centralizada.', strategy: ['**Segregación de Competencias:** El DI es plenamente competente para el diseño de la **Insonorización Pasiva** (tabiquería, acabados) y el cumplimiento de DB-HR.', '**Línea Roja (Instalaciones Fijas):** El "potente sistema de climatización centralizada" y los cálculos acústicos de emisión son una **Instalación Fija** de gran envergadura. Esto requiere la co-firma o proyecto segregado de un Ingeniero Industrial o Ingeniero Técnico.', '**Estrategia DI:** Liderar el proyecto arquitectónico/funcional, pero delegar la memoria de cálculo industrial en el Ingeniero.']}, 
                    eu: { title: 'D. Instalazioen Erronka (Diskoteka)', summary: 'Diskoteka baterako lokalaren egokitzapena. Insonorizazio pasiboa eta klima-sistema zentralizatu indartsu bat behar ditu.', strategy: ['**Eskuduntzen Segregazioa:** BD erabat eskuduna da **Insonorizazio Pasiboaren** (tabikeak, akaberak) diseinuan eta DB-HR betetzean.', '**Marra Gorria (Instalazio Finkoak):** "Klima-sistema zentralizatu indartsua" eta emisio akustikoen kalkuluak tamaina handiko **Instalazio Finko** bat dira. Horrek Industria Ingeniari edo Ingeniari Tekniko baten sinadura edo proiektu bereizia eskatzen du.', '**BD Estrategia:** Proiektu arkitektoniko/funtzionala gidatzea, baina kalkulu industrialaren memoria Ingeniariari eskuordetzea.']}
                },
                { id: 'E', solution: 'ID COMPETENTE', 
                    es: { title: 'E. Transformación de Local (Garaje a Oficina/Vivienda)', summary: 'Cambio de uso de un local de garaje/almacén a oficina profesional o vivienda. No afecta estructura.', strategy: ['**Competencia Principal:** El DI es el técnico idóneo para diseñar la **Adecuación Funcional** y garantizar el cumplimiento del CTE (DB-HS/SUA) para el nuevo uso (oficina/vivienda).', '**Límite Urbanístico Secundario:** El cambio de uso requiere confirmación de la compatibilidad en el planeamiento, pero la obra de adaptación es de **Escasa Entidad Constructiva** y cae bajo el DI.', '**Defensa Clave:** Usar la **Jerarquía Normativa** para evitar que la OOMM exija Arquitecto/Ingeniero sin base en la LOE.']}, 
                    eu: { title: 'E. Lokalaren Eraldaketa (Garajetik Bulegora/Etxebizitzara)', summary: 'Garaje/biltegi lokal baten erabilera aldatzea bulego profesional edo etxebizitza bihurtzeko. Egiturari ez dio eragiten.', strategy: ['**Eskuduntza Nagusia:** BD da **Egokitzapen Funtzionala** diseinatzeko eta erabilera berrirako (bulegoa/etxebizitza) EKTren (DB-HS/SUA) betetzea bermatzeko teknikari egokiena.', '**Bigarren Mailako Hirigintza Muga:** Erabilera aldaketak bateragarritasunaren berrespena eskatzen du plangintzan, baina egokitzapen obra **Eraikuntza Gutxiko Entitatea** da eta BDren ardurapean dago.', '**Defentsa Gakoa:** **Arau Hierarkia** erabiltzea Udal Ordenantzak Arkitektoa/Ingeniaria eska ez dezan, LOEan oinarriturik ez badago.']}
                },
                { id: 'F', solution: 'ID COMPETENTE', 
                    es: { title: 'F. División Comercial (Local en Dos Tiendas)', summary: 'Segregación de un gran local comercial en dos unidades independientes (dos tiendas) con aperturas de puertas y nuevos aseos.', strategy: ['**Naturaleza de la Obra:** La obra es una **Adecuación Funcional** y una **Modificación NO Esencial** de la distribución interna. No hay Obra Mayor.', '**Instalaciones:** La duplicación de los cuartos húmedos y sub-contadores es competencia del DI.', '**Defensa:** El DI firma y proyecta la distribución, la evacuación (DB-SI) y la accesibilidad (DB-SUA) de las dos nuevas unidades comerciales.']}, 
                    eu: { title: 'F. Merkataritza Zatiketa (Lokal Bat Bi Dendatan)', summary: 'Merkataritza-lokal handi bat bi unitate independentetan (bi denda) bereiztea, ate irekiera eta komun berriekin.', strategy: ['**Obraren Izaera:** Obra **Egokitzapen Funtzionala** eta barne banaketaren **Ezinbestekoa EZ den Aldaketa** da. Ez dago Obra Nagusirik.', '**Instalazioak:** Gela hezeak eta azpi-kontagailuak bikoiztea BDren eskuduntza da.', '**Defentsa:** BDk sinatzen eta proiektatzen ditu bi merkataritza-unitate berrien banaketa, ebakuazioa (DB-SI) eta irisgarritasuna (DB-SUA).']}
                },
                { id: 'G', solution: 'COLABORACIÓN NECESARIA', 
                    es: { title: 'G. Apertura de Vanos en Forjado (Línea Roja Estructural)', summary: 'Abrir un vano de 1.5 x 1.5 metros en el forjado entre dos plantas para instalar una escalera interior de diseño.', strategy: ['**LÍNEA ROJA INELUDIBLE:** Cualquier apertura en un forjado, muro de carga, pilar o viga afecta directamente al **Conjunto Sistema Estructural** del edificio.', '**Competencia:** Se requiere obligatoriamente la firma y cálculo de un **Arquitecto o Ingeniero** para el cálculo de la estructura auxiliar (viga de reparto) y la validación de la estabilidad global.', '**Estrategia DI:** El DI diseña la escalera, pero la parte de ejecución de la abertura del forjado debe ser dirigida y firmada por el técnico superior.']}, 
                    eu: { title: 'G. Forjaduko Baoen Irekiera (Egiturazko Marra Gorria)', summary: '1.5 x 1.5 metroko bao bat irekitzea bi solairuen arteko forjaduan barneko eskailera diseinatu bat instalatzeko.', strategy: ['**EZINBESTEKO MARRA GORRIA:** Forjatu, karga-horma, zutabe edo habetan egindako edozein irekierak zuzenean eragiten dio eraikinaren **Egitura Sistema Osoari**.', '**Eskuduntza:** Nahitaezkoa da **Arkitekto edo Ingeniari** baten sinadura eta kalkulua egitura osagarriaren (banaketa-habearen) kalkulua egiteko eta egonkortasun globala baliozkotzeko.', '**BD Estrategia:** BDk eskailera diseinatzen du, baina forjatuaren irekiera egiteko zatia goi mailako teknikari batek zuzendu eta sinatu behar du.']}
                },
                // Scenario H was truncated in the user's paste, completing the structure for functionality.
                { id: 'H', solution: 'COLABORACIÓN NECESARIA', 
                    es: { title: 'H. Ampliación de Vivienda Unifamiliar (Nueva Cimentación)', summary: 'Se propone una ampliación en la fachada principal de una vivienda unifamiliar, incluyendo la construcción de una nueva losa de cimentación y un muro de carga para soportar el nuevo volumen.', strategy: ['**Obra Mayor / Alteración del Conjunto Sistema Estructural:** Es un caso claro de Obra Mayor ya que implica la ejecución de la cimentación (Obra Nueva), la alteración del sistema estructural existente (transferencia de carga a nueva cimentación/muro), y la modificación de la envolvente. Se requiere obligatoriamente la firma de un **Arquitecto** o técnico superior. El DI puede diseñar el acabado interior y la distribución de la ampliación, pero el proyecto estructural troncal debe ser liderado por un técnico superior.']}, 
                    eu: { title: 'H. Familia Bakarreko Etxebizitzaren Luzapena (Oinarri Berria)', summary: 'Familia bakarreko etxebizitzaren fatxada nagusian luzapen bat proposatzen da, oinarri-lauza berri baten eraikuntza eta bolumen berriari eusteko karga-horma bat barne.', strategy: ['**Obra Nagusia / Egitura Sistema Osoaren Aldaketa:** Obra Nagusiko kasu argia da, oinarria exekutatzea (Obra Berria), egitura-sistema aldatzea (karga-transferentzia oinarri/horma berrira) eta ingurunearen aldaketa dakarrelako. Nahitaezkoa da **Arkitekto** edo goi mailako teknikari baten sinadura. BDk luzapenaren barne-akabera eta banaketa diseina ditzake, baina egiturazko oinarria goi mailako teknikari batek zuzendu behar du.']}
                }
            ],
            
            // Concepts that can be dragged and dropped
            concepts: [
                { id: 1, es: 'Adecuación Funcional', eu: 'Egokitzapen Funtzionala', category: 'ID COMPETENTE', hint: 'La obra se centra en el uso interior sin afectar estructura troncal o envolvente mayor.' },
                { id: 2, es: 'Instalaciones de Recinto (Punto III)', eu: 'Esparruko Instalazioak (III. puntua)', category: 'ID COMPETENTE', hint: 'Instalaciones internas (ej: tomas de agua, puntos de luz, sub-contadores) que no son acometidas fijas.' },
                { id: 3, es: 'Escasa Entidad Constructiva', eu: 'Eraikuntza Gutxiko Entitatea', category: 'ID COMPETENTE', hint: 'Obras sencillas de reforma que no alteran la volumetría ni la estructura troncal.' },
                { id: 4, es: 'Modificación NO Esencial', eu: 'Ezinbestekoa EZ den Aldaketa', category: 'ID COMPETENTE', hint: 'Los cambios de uso o distribución interna que mantienen las condiciones de habitabilidad y seguridad del edificio.' },
                { id: 5, es: 'Garantía de Habitabilidad (DB-HS)', eu: 'Bizigarritasunaren Bermea (DB-HS)', category: 'ID COMPETENTE', hint: 'Cumplimiento de las condiciones mínimas de ventilación, iluminación y salubridad.' },

                { id: 6, es: 'Conjunto Sistema Estructural', eu: 'Egitura Sistema Osoa', category: 'COLABORACIÓN NECESARIA', hint: 'Vigas, pilares, muros de carga o forjados. Requiere cálculo y firma de Arquitecto/Ingeniero.' },
                { id: 7, es: 'Alteración de la Volumetría', eu: 'Bolumenaren Aldaketa', category: 'COLABORACIÓN NECESARIA', hint: 'Aumento de superficie construida o edificabilidad (Obra Mayor). Requiere validación urbanística superior.' },
                { id: 8, es: 'Instalación Fija de Gran Envergadura', eu: 'Tamaina Handiko Instalazio Finkoa', category: 'COLABORACIÓN NECESARIA', hint: 'Climatización centralizada potente, ascensores, cálculos acústicos de emisión, etc. Requiere Ingeniero Industrial.' },
                { id: 9, es: 'Ejecución de Cimentación (Obra Nueva)', eu: 'Oinarria Exekutatzea (Obra Berria)', category: 'COLABORACIÓN NECESARIA', hint: 'Construcción desde el subsuelo. Es Obra Mayor y requiere Arquitecto/Técnico Superior.' },
            ],

            // Correct combination for each scenario (Concepts required in the Defense Zone)
            correct_combinations: {
                'A': [7], // Volume alteration requires collaboration
                'B': [1, 4], // Functional/Non-Essential change, ID Competente
                'C': [3, 5], // Minor entity and Habitability, ID Competente
                'D': [8], // Large fixed installation requires collaboration
                'E': [1, 3], // Functional adaptation and Minor entity, ID Competente
                'F': [1, 2], // Functional adaptation and Enclosure installations, ID Competente
                'G': [6], // Structural system alteration requires collaboration
                'H': [6, 9] // Structural system and New foundation requires collaboration
            }
        };

        // --- FIREBASE SETUP & AUTH ---
        async function setupFirebaseAndAuth() {
            try {
                window.firebase.app = initializeApp(firebaseConfig);
                window.firebase.db = getFirestore(window.firebase.app);
                window.firebase.auth = getAuth(window.firebase.app);

                const auth = window.firebase.auth;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                window.firebase.isFirebaseReady = true;
                window.dispatchEvent(new Event('firebaseReady')); 

            } catch (error) {
                console.error("Firebase setup failed:", error);
                document.getElementById('auth-message-eu').textContent = "Errorea Firebase-ekin konektatzean.";
                document.getElementById('auth-message-es').textContent = "Error al conectar con Firebase.";
            }
        }
        
        // --- AUTH UI HANDLERS ---
        window.showLoginForm = (lang) => {
            window.currentLang = lang;
            document.getElementById('login-form-eu').classList.toggle('hidden', lang !== 'eu');
            document.getElementById('login-form-es').classList.toggle('hidden', lang !== 'es');
            document.getElementById('auth-message-eu').textContent = '';
            document.getElementById('auth-message-es').textContent = '';
        };

        window.handleLogin = async (lang) => {
            if (!window.firebase.isFirebaseReady) {
                console.error("Firebase ez dago prest.");
                return;
            }

            const inputId = lang === 'eu' ? 'user-id-input' : 'user-id-input-es';
            const studentId = document.getElementById(inputId).value.trim().toUpperCase();
            const messageElement = lang === 'eu' ? document.getElementById('auth-message-eu') : document.getElementById('auth-message-es');

            if (studentId.length < 3) {
                messageElement.textContent = lang === 'eu' ? "ID laburregia." : "ID demasiado corto.";
                return;
            }

            window.firebase.studentId = studentId;
            document.getElementById('student-id-display').textContent = studentId;
            messageElement.textContent = '';
            
            // Check for TEACHER key
            if (studentId === TEACHER_KEY) {
                window.firebase.role = 'TEACHER';
                document.getElementById('auth-area').classList.add('hidden');
                document.getElementById('dashboard-area').classList.remove('hidden');
                document.getElementById('teacher-id-display').textContent = studentId;
                window.loadAllStudentProgress();
            } else {
                window.firebase.role = 'STUDENT';
                document.getElementById('auth-area').classList.add('hidden');
                document.getElementById('game-main-content').classList.remove('hidden');
                document.getElementById('scenario-selection').classList.remove('hidden');
                document.getElementById('user-info-bar').classList.remove('hidden');
                window.loadUserProgress(studentId);
            }
        };

        // --- FIREBASE DATA FUNCTIONS (Public Path: /artifacts/{appId}/public/data/game_scores/{studentId}) ---
        function getScoreRef(id) {
            const { db, appId } = window.firebase;
            return doc(db, 'artifacts', appId, 'public', 'data', 'game_scores', id);
        }

        window.loadUserProgress = async (studentId) => {
            const { db } = window.firebase;
            if (!db || !studentId) return;

            const progressRef = getScoreRef(studentId);
            try {
                const docSnap = await getDoc(progressRef);
                window.firebase.progress = {};
                if (docSnap.exists()) {
                    Object.assign(window.firebase.progress, docSnap.data().scores || {});
                }
                window.renderScenarioButtons(window.firebase.progress);
            } catch (error) {
                console.error("Error loading progress:", error);
            }
        };

        window.saveScenarioResult = async (scenarioId, isCorrect) => {
            const { db, studentId, progress } = window.firebase;
            if (!db || !studentId) {
                console.error("User ID not set. Cannot save score.");
                return;
            }

            const timestamp = new Date().toISOString();
            progress[scenarioId] = { correct: isCorrect, timestamp: timestamp };
            
            const progressRef = getScoreRef(studentId);
            
            try {
                await setDoc(progressRef, { 
                    studentId: studentId,
                    lastUpdated: timestamp,
                    scores: progress 
                }, { merge: true });
                console.log(`Scenario ${scenarioId} saved successfully for ${studentId}.`);
            } catch (error) {
                console.error("Error saving score:", error);
            }
        };
        
        window.loadAllStudentProgress = async () => {
            const { db, appId } = window.firebase;
            if (!db) {
                console.error("Database not ready.");
                return;
            }
            
            const scoresCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_scores');
            
            document.getElementById('dashboard-table-body').innerHTML = `<tr><td colspan="10" class="p-4 text-center text-blue-600 font-semibold">Kargatzen... / Cargando...</td></tr>`;
            
            try {
                const querySnapshot = await getDocs(scoresCollectionRef);
                const allScores = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const studentId = data.studentId;
                    // Filter out the teacher ID from the list
                    if (studentId === TEACHER_KEY) return; 

                    const scores = data.scores || {};
                    
                    let correctCount = 0;
                    Object.keys(scores).forEach(scenarioId => {
                        if (scores[scenarioId] && scores[scenarioId].correct) {
                            correctCount++;
                        }
                    });

                    allScores.push({ studentId, scores, correctCount });
                });
                
                // Sort by total correct count (descending) then by ID
                allScores.sort((a, b) => {
                    if (b.correctCount !== a.correctCount) {
                        return b.correctCount - a.correctCount;
                    }
                    return a.studentId.localeCompare(b.studentId);
                });

                window.renderDashboardTable(allScores);

            } catch (error) {
                console.error("Error loading all student progress:", error);
                document.getElementById('dashboard-table-body').innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-600">Errorea datuak kargatzean. / Error al cargar los datos.</td></tr>`;
            }
        };

        // --- GAME LOGIC FUNCTIONS ---

        // Translation dictionary
        const translations = {
            appTitle: { eu: 'LOE Challenge: BDren Bideragarritasuna', es: 'LOE Challenge: Viabilidad del DI' },
            appSubtitle: { eu: 'Probatu zure eskuduntzak Udal Berrikuspen Mahaian.', es: 'Prueba tus competencias en la Mesa de Revisión Municipal.' },
            logoutButton: { eu: 'Saioa Amaitu', es: 'Cerrar Sesión' },
            loginTitle: { eu: 'Plataformarako Sarbidea', es: 'Acceso a la Plataforma' },
            loginHint: { eu: 'Sartu zure NANa, matrikula-zenbakia, edo izena progresioari hasiera emateko.', es: 'Introduce tu DNI, número de matrícula o nombre.' },
            loginButton: { eu: 'Sartu', es: 'Acceder' },
            selectScenarioTitle: { eu: '1. Agertokia Aukeratu', es: '1. Selecciona el Escenario' },
            activeScenario: { eu: 'Agertoki Aktiboa', es: 'Escenario Activo' },
            mountDefenseTitle: { eu: '2. Zure Defentsa Muntatu (Arrastatu eta Askatu)', es: '2. Monta tu Defensa (Arrastrar y Soltar)' },
            conceptCardsTitle: { eu: 'LOE Kontzeptu Txartelak', es: 'Tarjetas de Concepto LOE' },
            defenseZoneTitle: { eu: 'BDren Defentsa Eremua', es: 'Zona de Defensa del DI' },
            defenseZoneHint: { eu: 'Arrastatu hona Barnealdeen Diseinatzailearen eskuduntza justifikatzen duten 2 edo 3 kontzeptuak.', es: 'Arrastra aquí 2 o 3 conceptos que justifiquen la competencia del Diseñador de Interiores.' },
            limitZoneTitle: { eu: 'Udalaren Mugak eta Erasoak', es: 'Límites y Ataques del Ayuntamiento' },
            limitZoneHint: { eu: 'Arrastatu hona eskuduntza baliogabetu edo muga dezaketen kontzeptuak.', es: 'Arrastra aquí los conceptos que anulan o limitan la competencia.' },
            checkButtonText: { eu: 'Eskuduntza Bideragarritasuna Egiaztatu', es: 'Comprobar Viabilidad de Competencia' },
            solutionTitle: { eu: 'Lege Justifikazioa eta Estrategia:', es: 'Justificación Legal y Estrategia:' },
            newChallengeButton: { eu: 'Erronka Berria', es: 'Nuevo Desafío' },
            resultCorrect: { eu: 'ZORIONAK! Emaitza zuzena da.', es: '¡ENHORABUENA! Resultado correcto.' },
            resultIncorrect: { eu: 'ERROREA! Emaitza ez da zuzena.', es: '¡ERROR! El resultado no es correcto.' },
            resultIDCompetente: { eu: 'BD ESKUDUNA da. Zure defentsa indartsua da!', es: 'El DI es COMPETENTE. ¡Tu defensa es sólida!' },
            resultColaboracion: { eu: 'NAHITAEZKO LANKIDETZA. Akats bat dago zure defentsan.', es: 'COLABORACIÓN NECESARIA. Hay un fallo en tu defensa.' },
            resultStrategyID: { eu: 'BDk proiektuaren lidergoa mantentzen du bere defentsan sartutako kontzeptuetan oinarrituta.', es: 'El DI mantiene el liderazgo del proyecto basándose en los conceptos de su defensa.' },
            resultStrategyColab: { eu: 'Beharrezkoa da goi mailako teknikari batekin lankidetzan aritzea, mugako kontzeptu bat dagoelako.', es: 'Es necesaria la colaboración con un técnico superior por la presencia de un concepto limitante.' },
            resultStrategyIncorrect: { eu: 'Erabili estrategia zuzena. Berrikusi zergatik den beharrezkoa lankidetza, edo zergatik ez.', es: 'Aplica la estrategia correcta. Revisa por qué es necesaria la colaboración, o por qué no.' },
            totalCorrectHeader: { eu: 'Total Zuzena', es: 'Total Correcto' },
            studentIdHeader: { eu: 'Ikasle IDa', es: 'ID del Alumno' }
        };

        window.updateTexts = () => {
            const lang = window.currentLang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[key] && translations[key][lang]) {
                    el.textContent = translations[key][lang];
                }
            });

            // Update zone headers that are not standard data-translate
            const scenario = rawData.scenarios.find(s => s.id === window.currentScenarioId);
            if (scenario) {
                document.getElementById('defense-zone').querySelector('h3').textContent = translations.defenseZoneTitle[lang];
                document.getElementById('limit-zone').querySelector('h3').textContent = translations.limitZoneTitle[lang];
                document.getElementById('defense-zone').querySelector('p').textContent = translations.defenseZoneHint[lang];
                document.getElementById('limit-zone').querySelector('p').textContent = translations.limitZoneHint[lang];
                document.getElementById('scenario-title').textContent = scenario[lang].title;
                document.getElementById('scenario-description').textContent = scenario[lang].summary;
            }
            
            // Update dashboard headers
            document.getElementById('total-correct-header').textContent = translations.totalCorrectHeader[lang];
            document.getElementById('student-id-header').textContent = translations.studentIdHeader[lang];
            document.getElementById('teacher-dashboard-title').textContent = window.firebase.role === 'TEACHER' ? translations.teacherDashboardTitle?.[lang] || 'Irakaslearen Kontrol-panela' : 'Irakaslearen Kontrol-panela';
        };

        window.renderDashboardTable = (allScores) => {
            const body = document.getElementById('dashboard-table-body');
            body.innerHTML = '';
            
            const scenarioIds = rawData.scenarios.map(s => s.id);

            allScores.forEach(data => {
                let row = `<tr class="hover:bg-gray-50">
                    <td class="p-3 font-semibold text-gray-800 text-left">${data.studentId}</td>`;
                
                scenarioIds.forEach(id => {
                    const score = data.scores[id];
                    let cellClass = 'bg-gray-200';
                    let content = '-';
                    if (score) {
                        if (score.correct) {
                            cellClass = 'bg-green-100 text-green-700 font-bold';
                            content = 'OK';
                        } else {
                            cellClass = 'bg-red-100 text-red-700 font-bold';
                            content = 'X';
                        }
                    }
                    row += `<td class="p-3 text-center ${cellClass}">${content}</td>`;
                });

                row += `<td class="p-3 text-center text-lg font-extrabold bg-purple-100 text-purple-800">${data.correctCount}/${scenarioIds.length}</td>`;
                row += `</tr>`;
                body.innerHTML += row;
            });
            
            if (allScores.length === 0) {
                 body.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500">Oraindik ez dago daturik. / Aún no hay datos.</td></tr>`;
            }
        };


        window.renderScenarioButtons = (progress) => {
            const container = document.getElementById('scenario-buttons');
            container.innerHTML = '';
            const lang = window.currentLang;

            rawData.scenarios.forEach(scenario => {
                const isSolved = progress[scenario.id];
                let btnClass = 'bg-blue-600 hover:bg-blue-700';
                let statusText = '';
                
                if (isSolved) {
                    if (isSolved.correct) {
                        btnClass = 'scenario-solved-correct hover:bg-green-700';
                        statusText = lang === 'eu' ? ' (Zuzena)' : ' (Correcto)';
                    } else {
                        btnClass = 'scenario-solved-incorrect hover:bg-red-700';
                        statusText = lang === 'eu' ? ' (Ez Zuzena)' : ' (Incorrecto)';
                    }
                }

                container.innerHTML += `
                    <button 
                        class="p-4 text-white font-bold rounded-lg shadow-md transition duration-150 ${btnClass}"
                        onclick="window.loadScenario('${scenario.id}')"
                    >
                        ${scenario[lang].title}
                        <span class="text-xs block font-normal mt-1">${statusText}</span>
                    </button>
                `;
            });
        };

        window.loadScenario = (scenarioId) => {
            window.currentScenarioId = scenarioId;
            const scenario = rawData.scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;

            // 1. Update Scenario Display
            document.getElementById('current-scenario-display').classList.remove('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('scenario-title').textContent = scenario[window.currentLang].title;
            document.getElementById('scenario-description').textContent = scenario[window.currentLang].summary;

            // 2. Reset and Render Cards
            window.resetGameArea();
            window.renderConceptCards();
            document.getElementById('check-button').disabled = true;

            // 3. Hide previous results
            document.getElementById('result-feedback').classList.add('hidden');
        };

        window.renderConceptCards = () => {
            const container = document.getElementById('concept-cards');
            container.innerHTML = '';
            const lang = window.currentLang;
            
            rawData.concepts.sort(() => Math.random() - 0.5).forEach(concept => { // Shuffle cards
                container.innerHTML += `
                    <div 
                        id="card-${concept.id}"
                        draggable="true" 
                        ondragstart="window.dragStart(event)"
                        class="card bg-gray-100 p-3 shadow-md text-sm font-semibold text-gray-800 defense-card"
                        data-id="${concept.id}"
                        data-category="${concept.category}"
                    >
                        ${concept[lang].eu}
                        <p class="text-xs font-normal text-gray-600 mt-1">${concept.hint}</p>
                    </div>
                `;
            });
        };

        window.resetGameArea = () => {
            const defenseZone = document.getElementById('defense-zone');
            const limitZone = document.getElementById('limit-zone');
            const conceptCards = document.getElementById('concept-cards');

            // Move all cards back to the concept cards area
            const allCards = [...defenseZone.children, ...limitZone.children].filter(el => el.classList.contains('card'));
            allCards.forEach(card => {
                conceptCards.appendChild(card);
            });
            
            // Reset zone hints
            document.getElementById('defense-zone').querySelector('p').classList.remove('hidden');
            document.getElementById('limit-zone').querySelector('p').classList.remove('hidden');

            // Re-render concept cards to ensure they are all present and shuffled (optional, but good for reset)
            window.renderConceptCards(); 
        };

        window.checkScenario = () => {
            const scenario = rawData.scenarios.find(s => s.id === window.currentScenarioId);
            if (!scenario) return;

            const defenseZone = document.getElementById('defense-zone');
            const limitZone = document.getElementById('limit-zone');
            
            const defenseCardIds = Array.from(defenseZone.querySelectorAll('.card'))
                .map(card => parseInt(card.dataset.id));
            const limitCardIds = Array.from(limitZone.querySelectorAll('.card'))
                .map(card => parseInt(card.dataset.id));

            const isCollaboracion = limitCardIds.some(id => 
                rawData.correct_combinations[scenario.id].includes(id)
            );

            // Determine if the final solution is "COLABORACIÓN NECESARIA" (NAHITAEZKO LANKIDETZA)
            const requiredSolutionIsColab = scenario.solution === 'COLABORACIÓN NECESARIA';
            
            let isCorrect;
            let resultTextKey, resultStrategyKey;
            
            if (requiredSolutionIsColab) {
                // Scenario requires collaboration (Line 6, 7, 8, or 9)
                isCorrect = isCollaboracion; 
                resultTextKey = isCorrect ? 'resultCorrect' : 'resultIncorrect';
                resultStrategyKey = isCorrect ? 'resultColaboracion' : 'resultStrategyIncorrect';
                
            } else {
                // Scenario is ID Competent (Line 1, 2, 3, 4, or 5)
                // Correct if NO collaboration concepts were dragged AND defense zone has right concepts
                const defenseConcepts = defenseCardIds.filter(id => !rawData.correct_combinations[scenario.id].includes(id));
                const requiredConcepts = rawData.correct_combinations[scenario.id];

                const hasRequiredConcepts = requiredConcepts.every(id => defenseCardIds.includes(id));
                const noLimitConceptsInLimitZone = !limitCardIds.some(id => requiredSolutionIsColab); // Should be true for ID Competente scenarios
                
                // Simple logic for ID COMPETENTE: No major limit concepts are selected, AND the main defense concepts are selected.
                isCorrect = !isCollaboracion && hasRequiredConcepts; 
                
                resultTextKey = isCorrect ? 'resultCorrect' : 'resultIncorrect';
                resultStrategyKey = isCorrect ? 'resultIDCompetente' : 'resultStrategyIncorrect';
            }
            
            // Save the result
            window.saveScenarioResult(window.currentScenarioId, isCorrect);
            
            // Display feedback
            window.displayFeedback(isCorrect, scenario[window.currentLang], resultTextKey, resultStrategyKey);
            
            // Reload buttons to show progress
            window.loadUserProgress(window.firebase.studentId);
        };

        window.displayFeedback = (isCorrect, scenarioData, resultTextKey, resultStrategyKey) => {
            const feedbackArea = document.getElementById('result-feedback');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const strategyList = document.getElementById('strategy-list');
            const lang = window.currentLang;

            feedbackArea.classList.remove('hidden', 'scenario-solved-correct', 'scenario-solved-incorrect');
            feedbackArea.classList.add(isCorrect ? 'scenario-solved-correct' : 'scenario-solved-incorrect');

            resultTitle.textContent = translations[resultTextKey][lang];
            resultMessage.innerHTML = isCorrect 
                ? `<span class="font-bold">${scenarioData.solution}.</span> ${translations[resultStrategyKey][lang]}`
                : `<span class="font-bold">${scenarioData.solution}.</span> ${translations[resultStrategyKey][lang]}`;

            strategyList.innerHTML = scenarioData.strategy.map(item => `<li>${item}</li>`).join('');

            document.getElementById('game-area').classList.add('hidden'); // Hide game area after checking
        };
        
        window.resetGame = () => {
            window.currentScenarioId = null;
            document.getElementById('scenario-selection').classList.remove('hidden');
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('result-feedback').classList.add('hidden');
            document.getElementById('current-scenario-display').classList.add('hidden');
            window.resetGameArea();
        };

        // --- DRAG AND DROP HANDLERS ---
        window.dragStart = (e) => {
            e.dataTransfer.setData('text/plain', e.target.id);
            e.target.style.opacity = '0.5';
        };

        window.dragEnter = (e) => {
            e.preventDefault();
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.add('active');
            }
        };

        window.dragOver = (e) => {
            e.preventDefault();
        };

        window.dragLeave = (e) => {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('active');
            }
        };
        
        const updateCheckButtonState = () => {
             const defenseCards = document.getElementById('defense-zone').querySelectorAll('.card').length;
             const limitCards = document.getElementById('limit-zone').querySelectorAll('.card').length;
             
             // Enable check button if at least one card is in one of the zones
             const isReady = defenseCards > 0 || limitCards > 0;
             document.getElementById('check-button').disabled = !isReady;
        }

        window.drop = (e) => {
            e.preventDefault();
            const data = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(data);
            const dropZone = e.target.closest('.drop-zone');

            if (draggedElement && dropZone) {
                dropZone.classList.remove('active');
                
                // Remove existing hint if it exists
                const hint = dropZone.querySelector('p');
                if (hint) hint.classList.add('hidden');

                // Determine which style class to use
                draggedElement.classList.remove('defense-card', 'limit-card');
                if (dropZone.id === 'defense-zone') {
                    draggedElement.classList.add('defense-card');
                } else if (dropZone.id === 'limit-zone') {
                    draggedElement.classList.add('limit-card');
                }

                dropZone.appendChild(draggedElement);
                draggedElement.style.opacity = '1';
                
                updateCheckButtonState();
            } else if (e.target.id === 'concept-cards' || e.target.closest('#concept-cards')) {
                // If dropped back into the source area
                const sourceZone = document.getElementById('concept-cards');
                sourceZone.appendChild(draggedElement);
                draggedElement.classList.remove('defense-card', 'limit-card');
                draggedElement.style.opacity = '1';
                updateCheckButtonState();
            }
        };
        
        // --- INITIALIZATION ---

        // Wait for Firebase to be ready before calling handleLogin if needed
        window.addEventListener('firebaseReady', () => {
            // No action needed here, authentication is handled by the user input (handleLogin)
            console.log("Firebase is ready and authenticated.");
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupFirebaseAndAuth();

            // Setup drag & drop listeners on zones
            const zones = document.querySelectorAll('.drop-zone, #concept-cards');
            zones.forEach(zone => {
                zone.addEventListener('dragover', window.dragOver);
                zone.addEventListener('dragenter', window.dragEnter);
                zone.addEventListener('dragleave', window.dragLeave);
                zone.addEventListener('drop', window.drop);
            });
            
            // Initial UI setup
            // showLoginForm('eu'); // Show EU form by default on initial load
        });
        
        // Fallback: Show EU form if no language is selected yet
        window.showLoginForm('eu');

    </script>
</body>

</html>
