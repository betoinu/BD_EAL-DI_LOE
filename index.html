<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOE Challenge: Eskuduntzen Kontrol-panela</title>
    <!-- Carga de Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    body {
    font-family: 'Inter', sans-serif;
    background-color: #f9fafb;
    padding: 0;
    }
    .card {
    cursor: grab;
    transition: transform 0.1s, box-shadow 0.1s;
    border-radius: 6px;
    /* Default card style, overridden by specific classes */
    border-left: 5px solid #6b7280; /* gray-500 */
    }
    .card:active {
    cursor: grabbing;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    }
    .drop-zone {
    min-height: 150px;
    border: 3px dashed #d1d5db;
    transition: all 0.2s;
    }
    .drop-zone.active {
    border-color: #10b981;
    background-color: #ecfdf5;
    transform: scale(1.02);
    }
    .defense-card {
    border-left: 5px solid #3b82f6; /* blue-500 */
    }
    .limit-card {
    border-left: 5px solid #ef4444; /* red-500 */
    }
    .scenario-solved-correct {
    background-color: #059669 !important; /* Tailwind green-600 */
    border: 3px solid #10b981; /* Tailwind emerald-500 */
    }
    .scenario-solved-incorrect {
    background-color: #dc2626 !important; /* Tailwind red-600 */
    border: 3px solid #f87171; /* Tailwind red-400 */
    }
    .scenario-solved-partial {
    background-color: #d97706 !important; /* Tailwind yellow-600 */
    border: 3px solid #f59e0b; /* Tailwind yellow-500 */
    }

    /* Custom scrollbar for better look */
    .card-container {
    max-height: 400px; /* Limit height for scroll */
    overflow-y: auto;
    }
    .card-container::-webkit-scrollbar {
    width: 8px;
    }
    .card-container::-webkit-scrollbar-thumb {
    background-color: #d1d5db; /* gray-300 */
    border-radius: 4px;
    }
    </style>
</head>
<body>

<div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- HEADER (Shared between Student and Teacher) -->
    <header class="text-center mb-6 bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800" data-translate="appTitle">LOE Challenge: BDren Bideragarritasuna</h1>
    <p class="text-gray-600 mt-2" data-translate="appSubtitle">Probatu zure eskuduntzak Udal Berrikuspen Mahaian.</p>

    <div id="user-info-bar" class="mt-4 text-sm text-gray-500 border-t pt-2 hidden">
    <p><span class="font-bold">Erabiltzaile Identifikazioa:</span> <span id="student-id-display" class="font-mono text-sm text-blue-600"></span></p>
    <button onclick="document.location.reload()" class="ml-4 text-xs text-red-500 hover:text-red-700 font-medium">
    <span data-translate="logoutButton">Saioa Amaitu</span>
    </button>
    </div>
    </header>

    <!-- PANTALLA 0: HIZKUNTZA ETA AUTENTIFIKAZIOA -->
    <div id="auth-area" class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10">
    <h2 class="text-3xl font-extrabold text-blue-800 mb-6 text-center">LOE Challenge</h2>

    <!-- Hizkuntza Aukeraketa -->
    <div class="mb-6 border-b pb-4">
    <h3 class="text-xl font-bold text-gray-700 mb-3 text-center">Aukeratu Hizkuntza / Elige Idioma</h3>
    <div class="flex justify-center space-x-4">
    <button onclick="window.currentLang='eu'; window.updateTexts(); window.showLoginForm('eu');" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
    Euskara
    </button>
    <button onclick="window.currentLang='es'; window.updateTexts(); window.showLoginForm('es');" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150">
    Castellano
    </button>
    </div>
    </div>

    <!-- Formulario EU -->
    <div id="login-form-eu" class="hidden">
    <h3 class="text-2xl font-bold text-gray-800 mb-4" data-translate="loginTitle">Plataformarako Sarbidea</h3>
    <p class="text-gray-600 mb-6" data-translate="loginHint">Sartu zure NANA, matrikula-zenbakia, edo izena progresioari hasiera emateko.</p>

    <input type="text" id="user-id-input" placeholder="Sartu hemen zure IDa (Irakaslea ere bada)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">

    <button onclick="window.handleLogin(window.currentLang)" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150" data-translate="loginButton">
    Sartu
    </button>
    <p id="auth-message-eu" class="text-red-500 text-sm mt-3"></p>
    </div>

    <!-- Formulario ES (Oculto por defecto) -->
    <div id="login-form-es" class="hidden">
    <h3 class="text-2xl font-bold text-gray-800 mb-4" data-translate="loginTitle">Acceso a la Plataforma</h3>
    <p class="text-gray-600 mb-6" data-translate="loginHint">Introduce tu DNI, número de matricula o nombre.</p>

    <input type="text" id="user-id-input-es" placeholder="Introduce aqui tu ID (también Profesor)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">

    <button onclick="window.handleLogin(window.currentLang)" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150" data-translate="loginButton">
    Acceder
    </button>
    <p id="auth-message-es" class="text-red-500 text-sm mt-3"></p>
    </div>
    </div>

    <!-- PANTALLA 1: IRAKASLEAREN KONTROL-PANELA (DASHBOARD) -->
    <div id="dashboard-area" class="hidden mt-6 bg-white p-8 rounded-xl shadow-2xl">
    <h2 id="teacher-dashboard-title" class="text-3xl font-extrabold text-purple-700 mb-2">Irakaslearen Kontrol-panela</h2>
    <p id="teacher-dashboard-subtitle" class="text-gray-600 mb-6">Ikasle guztien eskuduntza-erronken progresioa. (IDa: <span id="teacher-id-display" class="font-mono font-bold"></span>)</p>

    <button onclick="window.loadAllStudentProgress()" id="update-progress-button" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 mb-4">
    Progresioa Eguneratu
    </button>

    <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
    <thead class="bg-gray-100">
    <tr>
    <th id="student-id-header" class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Ikasle IDa</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">A</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">B</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">C</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">D</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">E</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">F</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">G</th>
    <th class="p-3 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">H</th>
    <th id="total-correct-header" class="p-3 text-center text-sm font-extrabold text-purple-700 uppercase tracking-wider bg-purple-200">Total Zuzenak</th>
    </tr>
    </thead>
    <tbody id="dashboard-table-body" class="divide-y divide-gray-200">
    <!-- Datuak hemen kargatuko dira -->
    </tbody>
    </table>
    </div>

    <button onclick="document.location.reload()" id="teacher-logout-button" class="mt-6 px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
    Saioa Amaitu
    </button>
    </div>

    <!-- PANTALLA 2: JOKOA (GAME MAIN CONTENT) -->
    <div id="game-main-content" class="hidden">
    <main>
    <!-- SECCIÓN 1: SELECTIÓN DEL ESCENARIO -->
    <div id="scenario-selection" class="mb-8 hidden">
    <h2 class="text-2xl font-bold text-gray-700 mb-4" data-translate="selectScenarioTitle">1. Agertokia Aukeratu</h2>
    <div id="scenario-buttons" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Los botones de escenario se generan aquí -->
    </div>
    <div id="current-scenario-display" class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-md hidden">
    <p class="font-semibold text-yellow-800"><span data-translate="activeScenario">Agertoki Aktiboa</span>: <span id="scenario-title" class="font-bold"></span></p>
    <p id="scenario-description" class="text-sm text-yellow-700"></p>
    </div>
    </div>

    <!-- SECCIÓN 2: DEFENSA Y ZONA DE JUEGO -->
    <div id="game-area" class="mt-10 hidden">
    <h2 class="text-2xl font-bold text-gray-700 mb-4" data-translate="mountDefenseTitle">2. Zure Defentsa Muntatu (Arrastatu eta Askatu)</h2>

    <div class="grid lg:grid-cols-3 gap-8">
    <!-- Columna 1: Cartas de Concepto LOE -->
    <div class="lg:col-span-1 bg-white p-4 rounded-xl shadow-md card-container">
    <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2" data-translate="conceptCardsTitle">LOE Kontzeptu Txartelak</h3>
    <div id="concept-cards" class="flex flex-wrap gap-2">
    <!-- Las cartas de concepto se generan aquí -->
    </div>
    </div>

    <!-- Columna 2: Zona de Defensa -->
    <div class="lg:col-span-1 bg-gray-50 p-6 rounded-xl shadow-inner drop-zone" id="defense-zone">
    <h3 class="text-xl font-semibold text-blue-700 mb-3" data-translate="defenseZoneTitle">BDren Defentsa Eremua</h3>
    <p class="text-gray-500 text-sm" data-translate="defenseZoneHint">Arrastatu hona Barnealdeen Diseinatzailearen eskuduntza justifikatzen duten 2 edo 3 kontzeptuak.</p>
    </div>

    <!-- Columna 3: Zona de Límites / Ataque -->
    <div class="lg:col-span-1 bg-red-50 p-6 rounded-xl shadow-inner drop-zone" id="limit-zone">
    <h3 class="text-xl font-semibold text-red-700 mb-3" data-translate="limitZoneTitle">Udalaren Mugak eta Erasoak</h3>
    <p class="text-gray-500 text-sm" data-translate="limitZoneHint">Arrastatu hona eskuduntza baliogabetu edo muga dezaketen kontzeptuak.</p>
    </div>
    </div>

    <div class="mt-8 text-center">
    <button id="check-button" onclick="window.checkScenario()" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 disabled:opacity-50" disabled data-translate="checkButtonText">
    Eskuduntza Bideragarritasuna Egiaztatu
    </button>
    </div>
    </div>

    <!-- SECCION 3: RESULTADO Y RETROALIMENTACION -->
    <div id="result-feedback" class="mt-10 p-6 rounded-xl shadow-xl hidden">
    <h2 id="result-title" class="text-3xl font-extrabold mb-3"></h2>
    <div id="result-message" class="text-lg mb-4"></div>
    <div id="solution-details" class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-400">
    <h3 class="font-bold text-gray-700 mb-2" data-translate="solutionTitle">Lege Justifikazioa eta Estrategia:</h3>
    <ul id="strategy-list" class="list-disc list-inside text-gray-700"></ul>
    </div>
    <button onclick="window.resetGame()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-translate="newChallengeButton">
    Erronka Berria
    </button>
    </div>
    </main>
    </div>
</div>

<!-- FIREBASE AND GAME LOGIC SCRIPT -->
<script type="module">
// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- GLOBAL STATE ---
window.firebase = {
    app: null,
    db: null,
    auth: null,
    studentId: null,
    appId: 'loe-challenge-game',
    progress: {},
    role: 'NONE',
    isFirebaseReady: false
};

window.currentLang = 'eu';
window.currentScenarioId = null;

const TEACHER_KEY = "IRAKASLEA";
const firebaseConfig = {
  apiKey: "AIzaSyB5jzbVWMiEzUPB2aTWfF6BbE-cf7aKvRE",
  authDomain: "nire-github-proiektua.firebaseapp.com",
  projectId: "nire-github-proiektua",
  storageBucket: "nire-github-proiektua.firebasestorage.app",
  messagingSenderId: "961383451425",
  appId: "1:961383451425:web:9be68f06509f5f97d2cc60",
  measurementId: "G-MT9P9C2MMB"
};

// --- RAW DATA (Scenarios and Concepts) ---
const rawData = {
    scenarios: [
    { 
        id: 'A', 
        solution: 'COLABORACIÓN NECESARIA',
        es: { 
            title: 'A. El Cerramiento de Balcón', 
            summary: 'Cerrar un balcón con estructura ligera y vidrio, aumentando la superficie útil interior.', 
            strategy: [
                '**Límite Urbanístico (Alteración del Volumen):** El aumento de la superficie habitable o construida obliga a revisar el coeficiente de edificabilidad, lo que empuja el proyecto a Obra Mayor o requiere la firma de un Arquitecto/Técnico para el cálculo volumétrico.',
                '**Estrategia DI:** El DI puede hacer el diseño, pero debe colaborar con un técnico superior para la validación urbanística y volumétrica ante el municipio.'
            ]
        },
        eu: { 
            title: 'A. Balkoiaren Itxitura', 
            summary: 'Balkoi bat egitura arinez eta beiraz ixtea, barruko azalera erabilgarria handituz.', 
            strategy: [
                '**Hirigintza Muga (Bolumenaren Aldaketa):** Bizigarri den edo eraikitako azaleraren handitzeak eraikigarritasun koefizientea berrikustea dakar. Horrek proiektua Obra Nagusira bultzatzen du edo Arkitekto/Teknikari baten sinadura eskatzen du kalkulu bolumetrikoa egiteko.',
                '**BD Estrategia:** BDk disenua egin dezake, baina udalerriaren aurrean hirigintza eta bolumen balioztapeneko goi mailako teknikari batekin lankidetzan aritu behar du.'
            ]
        }
    },
    { 
        id: 'B', 
        solution: 'COLABORACIÓN NECESARIA',
        es: { 
            title: 'B. El Cambio de Uso Mayor (Ermita a Kafe Antzokia)', 
            summary: 'Rehabilitar una ermita del S. XIX para un Kafe Antzokia (uso de pública concurrencia). No se toca estructura.', 
            strategy: [
                '**Complejidad Estructural Histórica:** La ermita del S.XIX con plantas intermedias existentes requiere verificación de cargas para uso de pública concurrencia (cafe antzoki).',
                '**Instalaciones de Gran Escala:** Necesidad de climatización, ventilación y acústica para alto aforo que superan el ámbito de instalaciones de recinto.',
                '**Competencia DI Limitada:** El DI mantiene competencia en diseño interior y distribución, pero requiere colaboración obligatoria con Arquitecto para verificación estructural y de instalaciones fijas.',
                '**Estrategia Mixta:** El DI lidera la adecuación funcional y el cumplimiento de DB-SUA/DB-SI, delegando en Arquitecto la verificación estructural y de instalaciones fijas.'
            ]
        },
        eu: { 
            title: 'B. Erabilera Aldaketa Nagusia (Ermitatik Kafe Antzokira)', 
            summary: 'XIX. mendeko ermita bat Kafe Antzoki (jendaurreko erabilera) baterako birgaitzea. Solairu tartekoak daude eta karga egituraren egiaztapena behar du.', 
            strategy: [
                '**Egitura Konplexutasun Historikoa:** XIX. mendeko ermitak solairu tartekoekin jendaurreko erabilerarako (kafe antzokia) karga egiaztapena eskatzen du.',
                '**Eskala Handiko Instalazioak:** Edukiera handiarentzako klima, aireztapen eta akustika beharrak esparruko instalazioen esparruitik harago doaz.',
                '**BDren Eskuduntza Mugatua:** BDk barne diseinua eta banaketarako eskuduntza mantentzen du, baina beharrezkoa da Arkitektoarekin lankidetza behartua egitura eta instalazio finkoen egiaztapenerako.',
                '**Estrategia Mistoa:** BDk gidatzen du egokitzapen funtzionala eta DB-SUA/DB-SI betetzea, Arkitektoari egitura eta instalazio finkoen egiaztapena eskuordetuz.'
          ]
        }
    },
    { 
        id: 'C', 
        solution: 'ID COMPETENTE',
        es: { 
            title: 'C. La Segregación de Vivienda', 
            summary: 'Dividir una vivienda grande en dos más pequeñas. Implica tirar tabiques no portantes y duplicar instalaciones de recinto.', 
            strategy: [
                '**Volumetría Neutra:** Es una obra **volumétricamente neutra** (no es Obra Mayor). El límite es el urbanismo (superficie mínima), no la obra en sí.',
                '**Especialización en Habitabilidad:** El DI es el técnico competente para demostrar la **Garantía de Habitabilidad** (DB-HS: ventilación, iluminación, superficie mínima) de las nuevas unidades.',
                '**Instalaciones de Recinto:** La duplicación de contadores/sub-contadores es **Instalación de Recinto** (Punto III), competencia directa del DI, sin afectar la acometida fija principal.'
            ]
        },
        eu: { 
            title: 'C. Etxebizitzaren Segregazioa', 
            summary: 'Etxebizitza handi bat bi txikiagotan zatitzea. Egiturazkoak ez diren tabikeak bota eta esparruko instalazioak bikoiztea dakar.', 
            strategy: [
                '**Bolumetría Neutroa:** **Bolumen aldetik neutroa** den obra da (ez da Obra Nagusia). Muga hirigintza da (gutxieneko azalera), ez obra bera.',
                '**Bizigarritasun Especializazioa:** BD da unitate berrien **Bizigarritasunaren Bermea** (DB-HS: aireztapena, argiztapena, gutxieneko azalera) frogatzeko teknikari eskuduna.',
                '**Esparruko Instalazioak:** Kontagailuak/azpi-kontagailuak bikoiztea **Esparruko Instalazioa** da (III. puntua), BDren eskuduntza zuzena, hartune finko nagusiari eragin gabe.'
            ]
        }
    },
    { 
        id: 'D', 
        solution: 'COLABORACIÓN NECESARIA',
        es: { 
            title: 'D. El Desafío de Instalaciones (Discoteca)', 
            summary: 'Adecuación de local para Discoteca. Requiere insonorización pasiva y un potente sistema de climatización centralizada.', 
            strategy: [
                '**Segregación de Competencias:** El DI es plenamente competente para el diseño de la **Insonorización Pasiva** (tabiquería, acabados) y el cumplimiento de DB-HR.',
                '**Línea Roja (Instalaciones Fijas):** El "potente sistema de climatización centralizada" y los cálculos acústicos de emisión son una **Instalación Fija** de gran envergadura. Esto requiere la co-firma o proyecto segregado de un Ingeniero Industrial o Ingeniero Técnico.',
                '**Estrategia DI:** Liderar el proyecto arquitectónico/funcional, pero delegar la memoria de cálculo industrial en el Ingeniero.'
            ]
        },
        eu: { 
            title: 'D. Instalazioen Erronka (Diskoteka)', 
            summary: 'Diskoteka baterako lokalaren egokitzapena. Insonorizazio pasiboa eta klima-sistema zentralizatu indartsu bat behar ditu.', 
            strategy: [
                '**Eskuduntzen Segregazioa:** BD erabat eskuduna da **Insonorizazio Pasiboaren** (tabikeak, akaberak) diseinuan eta DB-HR betetzean.',
                '**Marra Gorria (Instalazio Finkoak):** "Klima-sistema zentralizatu indartsua" eta emisio akustikoen kalkuluak tamaina handiko **Instalazio Finko** bat dira. Horrek Industria Ingeniari edo Ingeniari Tekniko baten sinadura edo proiektu bereizia eskatzen du.',
                '**BD Estrategia:** Proiektu arkitektoniko/funtzionala gidatzea, baina kalkulu industrialaren memoria Ingeniariari eskuordetzea.'
            ]
        }
    },
    { 
        id: 'E', 
        solution: 'ID COMPETENTE',
        es: { 
            title: 'E. Transformación de Local (Garaje a Oficina/Vivienda)', 
            summary: 'Cambio de uso de un local de garaje/almacén a oficina profesional o vivienda. No afecta estructura.', 
            strategy: [
                '**Competencia Principal:** El DI es el técnico idóneo para diseñar la **Adecuación Funcional** y garantizar el cumplimiento del CTE (DB-HS/SUA) para el nuevo uso (oficina/vivienda).',
                '**Límite Urbanístico Secundario:** El cambio de uso requiere confirmación de la compatibilidad en el planeamiento, pero la obra de adaptación es de **Escasa Entidad Constructiva** y cae bajo el DI.',
                '**Defensa Clave:** Usar la **Jerarquía Normativa** para evitar que la OOMM exija Arquitecto/Ingeniero sin base en la LOE.'
            ]
        },
        eu: { 
            title: 'E. Lokalaren Eraldaketa (Garajetik Bulegora/Etxebizitzara)', 
            summary: 'Garaje/biltegi lokal baten erabilera aldatzea bulego profesional edo etxebizitza bihurtzeko. Egiturari ez dio eragiten.', 
            strategy: [
                '**Eskuduntza Nagusia:** BD da **Egokitzapen Funtzionala** diseinatzeko eta erabilera berrirako (bulegoa/etxebizitza) EKTren (DB-HS/SUA) betetzea bermatzeko teknikari egokiena.',
                '**Bigarren Mailako Hirigintza Muga:** Erabilera aldaketak bateragarritasunaren berrespena eskatzen du plangintzan, baina egokitzapen obra **Eraikuntza Gutxiko Entitatea** da eta BDren ardurapean dago.',
                '**Defentsa Gakoa:** **Arau Hierarkia** erabiltzea Udal Ordenantzak Arkitektoa/Ingeniaria eska ez dezan, LOFan oinarriturik ez badago.'
            ]
        }
    },
    { 
        id: 'F', 
        solution: 'ID COMPETENTE',
        es: { 
            title: 'F. Diseño y Montaje de Stand en Feria de Muestras', 
            summary: 'Diseño completo de stand temporal en recinto ferial. Incluye estructura desmontable, iluminación especializada, gráfica y distribución espacial para exposición comercial.', 
            strategy: [
                '**Instalación Temporal Desmontable:** El stand es una estructura temporal no sujeta a licencia de obra, competencia directa del Diseñador de Interiores.',
                '**Diseño Espacial y Gráfico:** Composición espacial, circulación, iluminación escénica y diseño gráfico son competencias nucleares del DI.',
                '**Instalaciones Efímeras:** Todos los sistemas (eléctricos, iluminación, audiovisuales) son instalaciones temporales de recinto ferial.',
                '**Cumplimiento Normativa Ferial:** El DI garantiza cumplimiento de normativa específica del recinto (aforo, seguridad contra incendios, accesibilidad).'
            ]
        },
        eu: { 
            title: 'F. Erakustazokako Standaren Diseinua eta Muntaketa', 
            summary: 'Erakustazoko eremu bateko stand temporala osorik diseinatzea. Egitura desmuntagarria, argiztapen espezializatua, grafika eta espazio banaketa barne hartzen ditu erakusketa komertzialerako.', 
            strategy: [
                '**Instalazio Temporala Desmuntagarria:** Standa obra lizentziaren mende ez dagoen egitura temporala da, Barnealdeen Diseinatzailearen eskuduntza zuzena.',
                '**Espazio eta Grafiko Diseinua:** Konposizio espaziala, zirkulazioa, eszenikoa argiztapena eta grafiko diseinua BDren eskuduntza nuklearrak dira.',
                '**Instalazio Efemeroak:** Sistema guztiak (elektrikoak, argiztapena, audiobisualak) erakustazokoko esparruko instalazio temporalak dira.',
                '**Erakustazoko Araudi Betetzea:** BDk erakustazoko araudi espezifikoa betetzen duela bermatzen du (edukiera, suteen aurkako segurtasuna, irisgarritasuna).'
            ]
        }
    },
    { 
        id: 'G', 
        solution: 'COLABORACIÓN NECESARIA',
        es: { 
            title: 'G. Apertura de Vanos en Forjado', 
            summary: 'Abrir un vano de 1.5 x 1.5 metros en el forjado entre dos plantas para instalar una escalera interior de diseño.', 
            strategy: [
                '**LÍNEA ROJA INELUDIBLE:** Cualquier apertura en un forjado, muro de carga, pilar o viga afecta directamente al **Conjunto Sistema Estructural** del edificio.',
                '**Competencia:** Se requiere obligatoriamente la firma y cálculo de un **Arquitecto o Ingeniero** para el cálculo de la estructura auxiliar (viga de reparto) y la validación de la estabilidad global.',
                '**Estrategia DI:** El DI diseña la escalera, pero la parte de ejecución de la abertura del forjado debe ser dirigida y firmada por el técnico superior.'
            ]
        },
        eu: { 
            title: 'G. Forjaduko Baoen Irekiera', 
            summary: '1.5 x 1.5 metroko bao bat irekitzea bi solaireen arteko forjaduan barneko eskaliera diseinatu bat instalatzeko.', 
            strategy: [
                '**EZINBESTEKO MARRA GORRIA:** Forjatu, karga-horma, zutabe edo habetan egindako edozein irekierak zuzenean eragiten dio eraikinaren **Egitura Sistema Osuari**.',
                '**Eskuduntza:** Nahitaezkoa da **Arkitekto edo Ingeniari** baten sinadura eta kalkulua egitura osagarriaren (banaketa-habearen) kalkulua egiteko eta egonkortasun globala baliozkotzeko.',
                '**BD Estrategia:** BDk eskaliera diseinatzen du, baina forjatuaren irekiera egiteko zatia goi mailako teknikari batek zuzendu eta sinatu behar du.'
            ]
        }
    },
    { 
        id: 'H', 
        solution: 'COLABORACIÓN NECESARIA',
        es: { 
            title: 'H. Ampliación de Vivienda Unifamiliar (Nueva Cimentación)', 
            summary: 'Se propone una ampliación en la fachada principal de una vivienda unifamiliar, incluyendo la construcción de una nueva losa de cimentación y un muro de carga para soportar el nuevo volumen.', 
            strategy: [
                '**Obra Mayor / Alteración del Conjunto Sistema Estructural:** Es un caso claro de Obra Mayor ya que implica la ejecución de la cimentación (Obra Nueva), la alteración del sistema estructural existente (transferencia de carga a nueva cimentación/muro), y la modificación de la envolvente. Se requiere obligatoriamente la firma de un **Arquitecto** o técnico superior. El DI puede diseñar el acabado interior y la distribución de la ampliación, pero el proyecto estructural troncal debe ser liderado por un técnico superior.'
            ]
        },
        eu: { 
            title: 'H. Familia Bakarreko Etxebizitzaren Handitzea (Oin Berriko eraikina)', 
            summary: 'Familia bakarreko etxebizitzaren fatxada nagusian luzapen bat proposatzen da, oinarri-lauza berri baten eraikuntza eta bolumen berriari eusteko karga-horma bat barne.', 
            strategy: [
                '**Obra Nagusia / Egitura Sistema Osoaren Aldaketa:** Obra Nagusiko kasu argia da, oinarria egauzatzea (Obra Berria), egitura-sistema aldatzea (karga-transferentzia oinarri/horma berrira) eta inguratzailearen aldaketa dakarrelako. Nahitaezkoa da **Arkitekto** edo goi mailako teknikari baten sinadura. BDk handitzearen barne-akabera eta banaketa diseina ditzake, baina egiturazko oinarria goi mailako teknikari batek zuzendu behar du.'
            ]
        }
    },
    { 
    id: 'I', 
    solution: 'COLABORACIÓN NECESARIA',
    es: { 
        title: 'I. Reforma Integral Local Comercial en Edificio Histórico', 
        summary: 'Rehabilitación completa de local comercial en edificio catalogado (S. XIX). Incluye nueva distribución, instalaciones completas y adecuación a normativa actual.', 
        strategy: [
            '**Protección Patrimonial:** Edificio catalogado requiere informe de Conservación Histórica y posible intervención de Arquitecto especializado.',
            '**Intervención Integral:** Combinación de modificación estructural (refuerzos), instalaciones fijas (climatización, electricidad) y adecuación funcional.',
            '**Estrategia DI:** Puede liderar el diseño interior y distribución, pero necesita colaboración con Arquitecto para aspectos estructurales y patrimoniales.'
        ]
    },
    eu: { 
        title: 'I. Eraikin Historikoko Merkataritza Lokalaren Erreforma Integrala', 
        summary: 'XIX. mendeko eraikin katalogatuan merkataritza lokal baten eraberritze osoa. Banaketa berria, instalazio osoak eta egungo araudiara egokitzapena barne hartzen ditu.', 
        strategy: [
            '**Ondare Babesa:** Katalogatutako eraikinak Historia Kontserbazio txostena eta posible da Arkitekto espezializatuaren esku-hartzea behar dituela.',
            '**Eskuhartze Integrala:** Egitura aldaketa (indartzeak), instalazio finkoak (klimatizazioa, argindarra) eta egokitzapen funtzionalaren konbinaketa.',
            '**BD Estrategia:** Barne diseinua eta banaketa gidatu ditzake, baina Arkitektoarekin lankidetza behar du egitura eta ondare alderdietarako.'
        ]
    }
},
{ 
    id: 'J', 
    solution: 'COLABORACIÓN NECESARIA',
    es: { 
        title: 'J. Instalación de Ascensor en Comunidad de Vecinos', 
        summary: 'Instalación de nuevo ascensor en comunidad de vecinos existente. Requiere obra civil, hueco en forjados y nueva instalación electromecánica.', 
        strategy: [
            '**Obra Civil Estructural:** Apertura de huecos en forjados existentes y construcción de foso de ascensor afectan al sistema estructural.',
            '**Instalación Especializada:** Ascensor es instalación fija de gran envergadura que requiere Ingeniero Industrial para cálculos electromecánicos.',
            '**Competencia DI Limitada:** El DI puede coordinar el diseño de vestíbulo y acabados, pero la obra civil y instalación requieren técnicos superiores.'
        ]
    },
    eu: { 
        title: 'J. Igogailuaren Instalazioa Bizilagunen Komunitatean', 
        summary: 'Dagoen bizilagunen komunitatean igogailu berriaren instalazioa. Lan zibila, forjatuetako hutsuneak eta instalazio elektromekaniko berria eskatzen ditu.', 
        strategy: [
            '**Egitura Lan Zibila:** Forjatu existenteetako hutsuneen irekiera eta igogailuaren hobiaren eraikuntza egitura-sistemari eragiten diote.',
            '**Instalazio Espezializatua:** Igogailua tamaina handiko instalazio finkoa da eta Industria Ingeniaria eskatzen du kalkulu elektromekanikoetarako.',
            '**BDren Eskuduntza Mugatua:** BDk gela nagusiaren diseinua eta akaberak koordinatu ditzake, baina lan zibila eta instalazioak goi mailako teknikariak eskatzen ditu.'
        ]
    }
},
{ 
    id: 'K', 
    solution: 'ID COMPETENTE',
    es: { 
        title: 'K. Adecuación de Vivienda para Personas con Movilidad Reducida', 
        summary: 'Reforma de vivienda existente para mejorar accesibilidad: eliminación de barreras arquitectónicas, adaptación de baños y cocina, sin modificaciones estructurales.', 
        strategy: [
            '**Adecuación Funcional Especializada:** El DI es competente para diseñar soluciones de accesibilidad y eliminar barreras arquitectónicas internas.',
            '**Cumplimiento DB-SUA:** Garantizar condiciones de accesibilidad y seguridad de utilización es competencia directa del Diseñador de Interiores.',
            '**Instalaciones de Recinto:** Adaptación de baños y cocina con grifería especial, barras de apoyo, etc., son instalaciones de recinto competencia del DI.'
        ]
    },
    eu: { 
        title: 'K. Etxebizitzaren Egokitzapen Mugikortasun Urriko Pertsonentzat', 
        summary: 'Dagoen etxebizitzaren berrikuspena irisgarritasuna hobetzeko: arkitektura hesiak kentzea, komunak eta sukaldea egokitzea, egitura aldaketarik gabe.', 
        strategy: [
            '**Egokitzapen Funtzional Espezializatua:** BD da irisgarritasun irtenbideak diseinatzeko eta barne arkitektura hesiak kentzeko eskuduna.',
            '**DB-SUA Betetzea:** Irisgarritasun eta erabilera segurtasun baldintzak bermatzea Barnealdeen Diseinatzailearen eskuduntza zuzena da.',
            '**Esparruko Instalazioak:** Komunak eta sukaldea egokitzea griferia bereziarekin, euskarri barrak, etab., esparruko instalazioak dira BDren eskuduntza.'
        ]
    }
},
{ 
    id: 'L', 
    solution: 'COLABORACIÓN NECESARIA',
    es: { 
        title: 'L. Creación de Vivienda en Ático mediante Cubrición de Terraza', 
        summary: 'Transformación de terraza comunitaria en ático habitable mediante cerramiento completo. Incluye estructura ligera, instalaciones y acabados interiores.', 
        strategy: [
            '**Alteración Volumétrica Completa:** La cubrición de terraza altera la volumetría del edificio y constituye obra mayor que afecta a la configuración arquitectónica.',
            '**Afectación a Comunidad:** Obra que modifica elementos comunes (cubierta, fachada) requiere proyecto de Arquitecto y aprobación de la comunidad.',
            '**Competencia DI Parcial:** El DI puede diseñar el interior y distribución, pero la obra de cerramiento y modificación volumétrica requiere Arquitecto.'
        ]
    },
    eu: { 
        title: 'L. Etxebizitza Sortzea Teilatuan Terraza Estaliz', 
        summary: 'Terraza komunitarioa bizigarri den teilatu bihurtzea estaltze oso bidez. Egitura arina, instalazioak eta barne akaberak barne hartzen ditu.', 
        strategy: [
            '**Bolumen Aldaketa Osoa:** Terraza estaltzeak eraikinaren bolumetria aldatzen du eta arkitektura konfigurazioari eragiten dion obra nagusia osatzen du.',
            '**Komunitateari Eragina:** Elementu komunak (estalkia, fatxada) aldatzen dituen obrak Arkitektoaren proiektua eta komunitatearen onarpena eskatzen du.',
            '**BDren Eskuduntza Partziala:** BDk barnealdea eta banaketa diseina ditzake, baina estaltze lana eta bolumen aldaketa Arkitektoa eskatzen du.'
        ]
    }
},
],

    // Concepts that can be dragged and dropped
    concepts: [
        { 
            id: 1, 
            es: 'Adecuación Funcional', 
            eu: 'Egokitzapen Funtzionala', 
            category: 'ID COMPETENTE', 
            hint: 'La obra se centra en el uso interior sin afectar estructura troncal o envolvente mayor.',
            hint_eu: 'Lanak barne erabileran zentratzen du, egitura nagusia edo ingurune nagusia eragin gabe.'
        },
        { 
            id: 2, 
            es: 'Instalaciones de Recinto (Punto III)', 
            eu: 'Esparruko Instalazioak (III. puntua)', 
            category: 'ID COMPETENTE', 
            hint: 'Instalaciones internas (ej: tomas de agua, puntos de luz, sub-contadores) que no son acometidas fijas.',
            hint_eu: 'Barne instalazioak (adib: ur-hartuneak, argi-puntuak, azpi-kontagailuak) ez direnak hartune finkoak.'
        },
        { 
            id: 3, 
            es: 'Escasa Entidad Constructiva (Nueva Interpretación)', 
            eu: 'Eraikuntza Gutxiko Entitatea (Interpretazio Berria)', 
            category: 'ID COMPETENTE', 
            hint: 'Reformas que no alteran la configuración arquitectónica esencial del edificio ni su imagen volumétrica. Incluye modificaciones de distribución interior, tabiquería no estructural, y acabados superficiales.',
            hint_eu: 'Berrikuspenak ez du eraikinaren arkitektura konfigurazio esentziala edo irudi bolumetrikoa aldatzen. Barne banaketa aldaketak, egitura ez diren tabikeak eta azaleko akaberak barne hartzen ditu.'
        },
        { 
            id: 4, 
            es: 'Modificación NO Esencial', 
            eu: 'Ezinbestekoa EZ den Aldaketa', 
            category: 'ID COMPETENTE', 
            hint: 'Los cambios de uso o distribución interna que mantienen las condiciones de habitabilidad y seguridad del edificio.',
            hint_eu: 'Erabilera edo barne banaketa aldaketek eraikinaren bizigarritasun eta segurtasun baldintzak mantentzen dituzte.'
        },
        { 
            id: 5, 
            es: 'Garantía de Habitabilidad y Límites Urbanísticos', 
            eu: 'Bizigarritasunaren Bermea eta Hirigintza Mugak', 
            category: 'ID COMPETENTE', 
            hint: 'El DI puede justificar el cumplimiento de DB-HS (salubridad) pero debe verificar los límites urbanísticos: superficie mínima, ocupación, usos permitidos. Límite: modificaciones que alteren parámetros urbanísticos.',
            hint_eu: 'BDk DB-HS (osasun) betetzea justifika dezake baina hirigintza mugak egiaztatu behar ditu: gutxieneko azalera, okupazioa, onartutako erabilerak. Muga: hirigintza parametroak aldatzen dituzten aldaketak.'
        },
        { 
            id: 6, 
            es: 'Sistema Estructural y Cimentación (Unificado)', 
            eu: 'Egitura Sistema eta Oinarria (Baturik)', 
            category: 'COLABORACIÓN NECESARIA', 
            hint: 'Cualquier intervención en elementos estructurales portantes (forjados, muros carga, pilares, vigas) o en la cimentación. Incluye apertura de vanos, refuerzos, modificaciones de cargas y nueva cimentación.',
            hint_eu: 'Elementu egituralei (forjatuak, karga-hormak, zutabeak, habiak) edo oinarriri egindako edozein esku-hartze. Baoen irekiera, indartzeak, karga-aldaketak eta oinarri berria barne hartzen ditu.'
        },
        { 
            id: 7, 
            es: 'Alteración de la Volumetría', 
            eu: 'Bolumenaren Aldaketa', 
            category: 'COLABORACIÓN NECESARIA', 
            hint: 'Aumento de superficie construida o edificabilidad (Obra Mayor). Requiere validación urbanística superior.',
            hint_eu: 'Eraikitako azaleraren edo eraikigarritasunaren handitzea (Obra Nagusia). Goi mailako hirigintza balioztapena eskatzen du.'
        },
        { 
            id: 8, 
            es: 'Instalación Fija de Gran Envergadura', 
            eu: 'Tamaina Handiko Instalazio Finkoa', 
            category: 'COLABORACIÓN NECESARIA', 
            hint: 'Climatización centralizada potente, ascensores, cálculos acústicos de emisión, etc. Requiere Ingeniero Industrial.',
            hint_eu: 'Klima zentralizatu indartsua, igogailuak, emisio akustikoen kalkuluak, etab. Industria Ingeniaria eskatzen du.'
        },
        { 
            id: 10, 
            es: 'Intervención Total sobre el Edificio', 
            eu: 'Eraikinaren Gaineko Eskuhartze Osoa', 
            category: 'COLABORACIÓN NECESARIA', 
            hint: 'Cuando la obra afecta simultáneamente a estructura, instalaciones fijas, envolvente térmica y configuración arquitectónica. Requiere dirección integrada de Arquitecto.',
            hint_eu: 'Lanak aldi berean eragiten dionean egiturari, instalazio finkoei, ingurune termikoari eta arkitektura konfigurazioari. Arkitektoaren zuzendaritza integratua behar du.'
        },
        { 
            id: 11, 
            es: 'Cumplimiento CTE por DI (DB-HR, HS, SUA, SI)', 
            eu: 'EKTren Betetzea BDk (DB-HR, HS, SUA, SI)', 
            category: 'ID COMPETENTE', 
            hint: 'El Diseñador de Interiores puede justificar y proyectar el cumplimiento de: DB-HR (protección frente al ruido), DB-HS (salubridad), DB-SUA (seguridad de utilización) y DB-SI (seguridad en caso de incendio) en intervenciones de adecuación interior.',
            hint_eu: 'Barnealdeen Diseinatzaileak justifika eta proiekta dezake honen betetzea: DB-HR (zarataren aurkako babesa), DB-HS (osasuna), DB-SUA (erabilera segurtasuna) eta DB-SI (sute kasuan segurtasuna) barne egokitzapen esku-hartzeetan.'
        },
        { 
            id: 12, 
            es: 'Envolvente y Configuración Arquitectónica (DB-HE)', 
            eu: 'Ingurunea eta Arkitektura Konfigurazioa (DB-HE)', 
            category: 'COLABORACIÓN NECESARIA', 
            hint: 'Modificaciones que alteran la imagen arquitectónica del edificio, fachadas, cubiertas, o la envolvente térmica (DB-HE). El DI puede intervenir en acabados interiores pero no en la reconfiguración arquitectónica esencial.',
            hint_eu: 'Eraikinaren irudi arkitektonikoa, fatxadak, estalkiak edo ingurune termikoa (DB-HE) aldatzen duten aldaketak. BDk barne-akaberetan esku hartu dezake baina ez arkitektura berkonfigurazio esentzialean.'
        }
    ],
    
    // Correct combination for each scenario (Concepts required in the Defense Zone)
    correct_combinations: {
        'A': [7, 12],    // Alteración volumetría + Envolvente arquitectónica
        'B': [6],        // Sistema estructural (verificación cargas plantas)
        'C': [3, 5, 11], // Escasa entidad + Habitabilidad límites + Cumplimiento CTE DI
        'D': [8, 6],     // Instalación gran envergadura + Sistema estructural (vibraciones)
        'E': [1, 3, 11], // Adecuación funcional + Escasa entidad + Cumplimiento CTE DI
        'F': [1, 2, 11], // Adecuación funcional + Instalaciones recinto + Cumplimiento CTE DI (MANTENIDO)
        'G': [6],        // Sistema estructural unificado
        'H': [6, 12, 10],// Sistema estructural + Envolvente + Intervención total
        'I': [10, 12, 6],// Intervención total + Envolvente + Sistema estructural (edificio histórico)
        'J': [6, 8, 10], // Sistema estructural + Instalación gran envergadura + Intervención total
        'K': [1, 11, 3], // Adecuación funcional + Cumplimiento CTE DI + Escasa entidad
        'L': [7, 12, 10] // Alteración volumetría + Envolvente + Intervención total
    }
};

// --- FIREBASE SETUP & AUTH ---
async function setupFirebaseAndAuth() {
    try {
    window.firebase.app = initializeApp(firebaseConfig);
    window.firebase.db = getFirestore(window.firebase.app);
    window.firebase.auth = getAuth(window.firebase.app);

    const auth = window.firebase.auth;
    await signInAnonymously(auth);

    window.firebase.isFirebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
    console.log("Firebase setup successful");
    } catch (error) {
    console.error("Firebase setup failed:", error);
    document.getElementById('auth-message-eu').textContent = "Errorea Firebase-ekin konektatzean.";
    document.getElementById('auth-message-es').textContent = "Error al conectar con Firebase.";
    }
}

// --- AUTH UI HANDLERS ---
window.showLoginForm = (lang) => {
    window.currentLang = lang;

    document.getElementById('login-form-eu').classList.toggle('hidden', lang !== 'eu');
    document.getElementById('login-form-es').classList.toggle('hidden', lang !== 'es');

    document.getElementById('auth-message-eu').textContent = "";
    document.getElementById('auth-message-es').textContent = "";
};

window.handleLogin = async (lang) => {
    if (!window.firebase.isFirebaseReady) {
    console.error("Firebase ez dago prest.");
    return;
    }

    const inputId = lang === 'eu' ? 'user-id-input' : 'user-id-input-es';
    const studentId = document.getElementById(inputId).value.trim().toUpperCase();
    const messageElement = lang === 'eu' ? document.getElementById('auth-message-eu') : document.getElementById('auth-message-es');

    if (studentId.length < 3) {
    messageElement.textContent = lang === 'eu' ? "ID laburregia." : "ID demasiado corto.";
    return;
    }

    window.firebase.studentId = studentId;
    document.getElementById('student-id-display').textContent = studentId;
    messageElement.textContent = '';

    // Check for TEACHER key
    if (studentId === TEACHER_KEY) {
    window.firebase.role = 'TEACHER';
    document.getElementById('auth-area').classList.add('hidden');
    document.getElementById('dashboard-area').classList.remove('hidden');
    document.getElementById('teacher-id-display').textContent = studentId;
    window.loadAllStudentProgress();
    } else {
    window.firebase.role = 'STUDENT';
    document.getElementById('auth-area').classList.add('hidden');
    document.getElementById('game-main-content').classList.remove('hidden');
    document.getElementById('scenario-selection').classList.remove('hidden');
    document.getElementById('user-info-bar').classList.remove('hidden');
    window.loadUserProgress(studentId);
    }
};

// --- FIREBASE DATA FUNCTIONS ---
function getScoreRef(id) {
    const { db, appId } = window.firebase;
    return doc(db, 'artifacts', appId, 'public', 'data', 'game_scores', id);
}

window.loadUserProgress = async (studentId) => {
    const { db } = window.firebase;
    if (!db || !studentId) return;

    const progressRef = getScoreRef(studentId);
    try {
    const docSnap = await getDoc(progressRef);
    window.firebase.progress = {};
    if (docSnap.exists()) {
    Object.assign(window.firebase.progress, docSnap.data().scores || {});
    }
    window.renderScenarioButtons(window.firebase.progress);
    } catch (error) {
    console.error("Error loading progress:", error);
    }
};

// --- PUNTUAKETA SISTEMA BERRIA ---
function calculateScore(attempts) {
    if (!attempts || attempts.length === 0) return 0;

    const firstAttempt = attempts[0];
    const secondAttempt = attempts[1];

    // Lehen saiakeran zuzena bada → 3 puntu
    if (firstAttempt && firstAttempt.correct) {
    return 3;
    }

    // Bigarren saiakeran zuzena bada → 1 puntu
    if (secondAttempt && secondAttempt.correct) {
    return 1;
    }

    // Bestela → 0 puntu
    return 0;
}

window.saveScenarioResult = async (scenarioId, isCorrect) => {
    const { db, studentId, progress } = window.firebase;
    if (!db || !studentId) {
    console.error("User ID not set. Cannot save score.");
    return;
    }

    const timestamp = new Date().toISOString();

    // Saiakera berria gehitzea
    if (!progress[scenarioId]) {
    progress[scenarioId] = { attempts: [] };
    }

    progress[scenarioId].attempts.push({
    correct: isCorrect,
    timestamp: timestamp
    });

    // Saiakera kopurua mugatzea (max 3)
    if (progress[scenarioId].attempts.length > 3) {
    progress[scenarioId].attempts = progress[scenarioId].attempts.slice(-3);
    }

    const progressRef = getScoreRef(studentId);

    try {
    await setDoc(progressRef, {
    studentId: studentId,
    lastUpdated: timestamp,
    scores: progress
    }, { merge: true });
    console.log(`Scenario ${scenarioId} saved successfully for ${studentId}.`);
    } catch (error) {
    console.error("Error saving score:", error);
    }
};

window.loadAllStudentProgress = async () => {
    const { db, appId } = window.firebase;
    if (!db) {
    console.error("Database not ready.");
    return;
    }

    const scoresCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_scores');

    document.getElementById('dashboard-table-body').innerHTML = '<tr><td colspan="10" class="p-4 text-center text-blue-600 font-semibold">Kargatzen... / Cargando...</td></tr>';

    try {
    const querySnapshot = await getDocs(scoresCollectionRef);

    const allScores = [];
    querySnapshot.forEach((doc) => {
    const data = doc.data();
    const studentId = data.studentId;
    // Filter out the teacher ID from the list
    if (studentId === TEACHER_KEY) return;

    const scores = data.scores || {};
    let correctCount = 0;

    Object.keys(scores).forEach(scenarioId => {
    const scenarioData = scores[scenarioId];
    if (scenarioData && scenarioData.attempts) {
    correctCount += calculateScore(scenarioData.attempts);
    }
    });

    allScores.push({ studentId, scores, correctCount });
    });

    // Sort by total correct count (descending) then by ID
    allScores.sort((a, b) => {
    if (b.correctCount !== a.correctCount) {
    return b.correctCount - a.correctCount;
    }
    return a.studentId.localeCompare(b.studentId);
    });

    window.renderDashboardTable(allScores);
    } catch (error) {
    console.error("Error loading student progress:", error);
    document.getElementById('dashboard-table-body').innerHTML = '<tr><td colspan="10" class="p-4 text-center text-red-500">Errorea datuak kargatzean / Error cargando datos</td></tr>';
    }
};

// Translation dictionary
const translations = {
    appTitle: { eu: 'LOE Challenge: BDren Bideragarritasuna', es: 'LOE Challenge: Viabilidad del DI' },
    appSubtitle: { eu: 'Probatu zure eskuduntzak Udal Berrikuspen Mahaian.', es: 'Prueba tus competencias en la Mesa de Revisión Municipal.' },
    logoutButton: { eu: 'Saioa Amaitu', es: 'Cerrar Sesión' },
    loginTitle: { eu: 'Plataformarako Sarbidea', es: 'Acceso a la Plataforma' },
    loginHint: { eu: 'Sartu zure NANA, matrikula-zenbakia, edo izena progresioari hasiera emateko.', es: 'Introduce tu DNI, número de matricula o nombre.' },
    loginButton: { eu: 'Sartu', es: 'Acceder' },
    selectScenarioTitle: { eu: '1. Agertokia Aukeratu', es: '1. Selecciona el Escenario' },
    activeScenario: { eu: 'Agertoki Aktiboa', es: 'Escenario Activo' },
    mountDefenseTitle: { eu: '2. Zure Defentsa Muntatu (Arrastatu eta Askatu)', es: '2. Monta tu Defensa (Arrastrar y Soltar)' },
    conceptCardsTitle: { eu: 'LOE Kontzeptu Txartelak', es: 'Tarjetas de Concepto LOE' },
    defenseZoneTitle: { eu: 'BDren Defentsa Eremua', es: 'Zona de Defensa del DI' },
    defenseZoneHint: { eu: 'Arrastatu hona Barnealdeen Diseinatzailearen eskuduntza justifikatzen duten 2 edo 3 kontzeptuak.', es: 'Arrastra aqui 2 o 3 conceptos que justifiquen la competencia del Diseñador de Interiores.' },
    limitZoneTitle: { eu: 'Udalaren Mugak eta Erasoak', es: 'Límites y Ataques del Ayuntamiento' },
    limitZoneHint: { eu: 'Arrastatu hona eskuduntza baliogabetu o muga dezaketen kontzeptuak.', es: 'Arrastra aqui los conceptos que anulan o limitan la competencia.' },
    checkButtonText: { eu: 'Eskuduntza Bideragarritasuna Egiaztatu', es: 'Comprobar Viabilidad de Competencia' },
    solutionTitle: { eu: 'Lege Justifikazioa eta Estrategia:', es: 'Justificación Legal y Estrategia:' },
    newChallengeButton: { eu: 'Erronka Berria', es: 'Nuevo Desafío' },
    resultCorrect: { eu: 'ZORIONAK! Emaitza zuzena da.', es: '¡ENHORABUENA! Resultado correcto.' },
    resultIncorrect: { eu: 'ERROREA! Emaitza ez da zuzena.', es: '¡ERROR! El resultado no es correcto.' },
    resultIDCompetente: { eu: 'BD ESKUDUNA da. Zure defentsa indartsua da!', es: 'El DI es COMPETENTE. ¡Tu defensa es sólida!' },
    resultCollaboracion: { eu: 'NAHITAEZKO LANKIDETZA. Akats bat dago zure defentsan.', es: 'COLABORACIÓN NECESARIA. Hay un fallo en tu defensa.' },
    resultStrategyID: { eu: 'BDk proiektuaren lidergoa mantentzen du bere defentsan sartutako kontzeptuetan oinarrituta.', es: 'El DI mantiene el liderazgo del proyecto basándose en los conceptos de su defensa.' },
    resultStrategyColab: { eu: 'Beharrezkoa da goi mailako teknikari batekin lankidetzan aritzea, mugako kontzeptu bat dagoelako.', es: 'Es necesaria la colaboración con un técnico superior por la presencia de un concepto limitante.' },
    resultStrategyIncorrect: { eu: 'Erabili estrategia zuzena. Berrikusi zergatik den beharrezkoa lankidetza, edo zergatik ez.', es: 'Aplica la estrategia correcta. Revisa por qué es necesaria la colaboración, o por qué no.' },
    totalCorrectHeader: { eu: 'Total Zuzenak', es: 'Total Correcto' },
    studentIdHeader: { eu: 'Ikasle IDa', es: 'ID del Alumno' },
    teacherDashboardTitle: { eu: 'Irakaslearen Kontrol-panela', es: 'Panel de Control del Profesor' }
};

window.updateTexts = () => {
    const lang = window.currentLang;
    document.querySelectorAll('[data-translate]').forEach(el => {
    const key = el.getAttribute('data-translate');
    if (translations[key] && translations[key][lang]) {
    el.textContent = translations[key][lang];
    }
    });

    // Update zone headers that are not standard data-translate
    const scenario = rawData.scenarios.find(s => s.id === window.currentScenarioId);
    if (scenario) {
    document.getElementById('defense-zone').querySelector('h3').textContent = translations.defenseZoneTitle[lang];
    document.getElementById('limit-zone').querySelector('h3').textContent = translations.limitZoneTitle[lang];
    document.getElementById('defense-zone').querySelector('p').textContent = translations.defenseZoneHint[lang];
    document.getElementById('limit-zone').querySelector('p').textContent = translations.limitZoneHint[lang];
    document.getElementById('scenario-title').textContent = scenario[lang].title;
    document.getElementById('scenario-description').textContent = scenario[lang].summary;
    }

    // Update dashboard headers
    document.getElementById('total-correct-header').textContent = translations.totalCorrectHeader[lang];
    document.getElementById('student-id-header').textContent = translations.studentIdHeader[lang];

    document.getElementById('teacher-dashboard-title').textContent = window.firebase.role === 'TEACHER' ? 
    translations.teacherDashboardTitle[lang] : 'Irakaslearen Kontrol-panela';
};

window.renderDashboardTable = (allScores) => {
    const body = document.getElementById('dashboard-table-body');
    body.innerHTML = '';
    const scenarioIds = rawData.scenarios.map(s => s.id);

    allScores.forEach(data => {
    let row = '<tr class="hover:bg-gray-50"><td class="p-3 font-semibold text-gray-800 text-left">' + data.studentId + '</td>';
    let totalScore = 0;

    scenarioIds.forEach(id => {
    const scoreData = data.scores[id];
    let cellClass = 'bg-gray-200';
    let content = '-';
    let points = 0;

    if (scoreData && scoreData.attempts) {
    points = calculateScore(scoreData.attempts);
    totalScore += points;

    if (points === 3) {
    cellClass = 'bg-green-100 text-green-700 font-bold';
    content = '3★';
    } else if (points === 1) {
    cellClass = 'bg-yellow-100 text-yellow-700 font-bold';
    content = '1★';
    } else if (scoreData.attempts.length > 0) {
    cellClass = 'bg-red-100 text-red-700 font-bold';
    content = '0';
    }
    }

    row += '<td class="p-3 text-center ' + cellClass + '">' + content + '</td>';
    });

    row += '<td class="p-3 text-center text-lg font-extrabold bg-purple-100 text-purple-800">' + totalScore + '</td>';
    row += '</tr>';
    body.innerHTML += row;
    });

    if (allScores.length === 0) {
    body.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">Ez dago daturik / No hay datos</td></tr>';
    }
};

window.renderScenarioButtons = (progress) => {
    const container = document.getElementById('scenario-buttons');
    container.innerHTML = '';
    const lang = window.currentLang;

    rawData.scenarios.forEach(scenario => {
        const scenarioData = progress[scenario.id];
        let btnClass = 'p-4 font-bold rounded-lg shadow-md transition duration-150 bg-blue-600 hover:bg-blue-700 text-white';

        if (scenarioData && scenarioData.attempts) {
            const points = calculateScore(scenarioData.attempts);

            if (points === 3) {
                btnClass = 'p-4 font-bold rounded-lg shadow-md transition duration-150 scenario-solved-correct hover:bg-green-700 text-white';
            } else if (points === 1) {
                btnClass = 'p-4 font-bold rounded-lg shadow-md transition duration-150 bg-yellow-600 hover:bg-yellow-700 text-white';
            } else if (scenarioData.attempts.length > 0) {
                btnClass = 'p-4 font-bold rounded-lg shadow-md transition duration-150 scenario-solved-incorrect hover:bg-red-700 text-white';
            }
        }

        container.innerHTML += `
            <button class="${btnClass}" onclick="window.loadScenario('${scenario.id}')">
                ${scenario[lang].title}
            </button>`;
    });
};

window.loadScenario = (scenarioId) => {
    window.currentScenarioId = scenarioId;
    const scenario = rawData.scenarios.find(s => s.id === scenarioId);
    if (!scenario) return;

    // 1. Update Scenario Display
    document.getElementById('current-scenario-display').classList.remove('hidden');
    document.getElementById('game-area').classList.remove('hidden');
    document.getElementById('scenario-title').textContent = scenario[window.currentLang].title;
    document.getElementById('scenario-description').textContent = scenario[window.currentLang].summary;

    // 2. Reset and Render Cards
    window.resetGameArea();
    window.renderConceptCards();
    document.getElementById('check-button').disabled = true;

    // 3. Hide previous results
    document.getElementById('result-feedback').classList.add('hidden');
};

window.renderConceptCards = () => {
    const container = document.getElementById('concept-cards');
    container.innerHTML = "";
    const lang = window.currentLang;

    rawData.concepts.sort(() => Math.random() - 0.5).forEach(concept => {
        // Usar hint_eu si está disponible, si no usar hint original
        const hintText = concept.hint_eu || concept.hint;
        container.innerHTML += `
        <div id="card-${concept.id}" draggable="true" ondragstart="window.dragStart(event)"
            class="card bg-gray-100 p-3 shadow-md text-sm font-semibold text-gray-800"
            data-id="${concept.id}" data-category="${concept.category}">
            ${concept[lang]}
            <p class="text-xs font-normal text-gray-600 mt-1">${hintText}</p>
        </div>`;
    });
};

window.resetGameArea = () => {
    const defenseZone = document.getElementById('defense-zone');
    const limitZone = document.getElementById('limit-zone');
    const conceptCards = document.getElementById('concept-cards');

    // Move all cards back to the concept cards area
    const allCards = [...defenseZone.children, ...limitZone.children].filter(el => el.classList.contains('card'));
    allCards.forEach(card => {
    conceptCards.appendChild(card);
    card.classList.remove('defense-card', 'limit-card');
    });

    // Reset zone hints
    document.getElementById('defense-zone').querySelector('p').classList.remove('hidden');
    document.getElementById('limit-zone').querySelector('p').classList.remove('hidden');

    // Re-render concept cards to ensure they are all present and shuffled
    window.renderConceptCards();
};

window.checkScenario = () => {
    const scenario = rawData.scenarios.find(s => s.id === window.currentScenarioId);
    if (!scenario) return;

    const defenseZone = document.getElementById('defense-zone');
    const limitZone = document.getElementById('limit-zone');

    const defenseCardIds = Array.from(defenseZone.querySelectorAll('.card')).map(card => parseInt(card.dataset.id));
    const limitCardIds = Array.from(limitZone.querySelectorAll('.card')).map(card => parseInt(card.dataset.id));

    // Check if any collaboration concepts are in the limit zone
    const isCollaboracion = limitCardIds.some(id => {
    const concept = rawData.concepts.find(c => c.id === id);
    return concept && concept.category === 'COLABORACIÓN NECESARIA';
    });

    // Determine if the final solution is "COLABORACIÓN NECESARIA"
    const requiredSolutionIsColab = scenario.solution === 'COLABORACIÓN NECESARIA';

    let isCorrect;
    let resultTextKey, resultStrategyKey;

    if (requiredSolutionIsColab) {
    // Scenario requires collaboration - correct if collaboration concepts are in limit zone
    isCorrect = isCollaboracion;
    resultTextKey = isCorrect ? 'resultCorrect' : 'resultIncorrect';
    resultStrategyKey = isCorrect ? 'resultCollaboracion' : 'resultStrategyIncorrect';
    } else {
    // Scenario is ID Competent - correct if NO collaboration concepts AND defense has required concepts
    const requiredConcepts = rawData.correct_combinations[scenario.id];
    const hasRequiredConcepts = requiredConcepts.every(id => defenseCardIds.includes(id));
    
    isCorrect = !isCollaboracion && hasRequiredConcepts;
    resultTextKey = isCorrect ? 'resultCorrect' : 'resultIncorrect';
    resultStrategyKey = isCorrect ? 'resultIDCompetente' : 'resultStrategyIncorrect';
    }

    // Save the result
    window.saveScenarioResult(window.currentScenarioId, isCorrect);

    // Display feedback
    window.displayFeedback(isCorrect, scenario[window.currentLang], resultTextKey, resultStrategyKey);

    // Reload buttons to show progress
    window.loadUserProgress(window.firebase.studentId);
};

window.displayFeedback = (isCorrect, scenarioData, resultTextKey, resultStrategyKey) => {
    const feedbackArea = document.getElementById('result-feedback');
    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const strategyList = document.getElementById('strategy-list');
    const lang = window.currentLang;

    feedbackArea.classList.remove('hidden', 'scenario-solved-correct', 'scenario-solved-incorrect');
    feedbackArea.classList.add(isCorrect ? 'scenario-solved-correct' : 'scenario-solved-incorrect');

    resultTitle.textContent = translations[resultTextKey][lang];
    resultMessage.innerHTML = isCorrect ? 
    `<span class="font-bold">${scenarioData.solution}.</span> ${translations[resultStrategyKey][lang]}` : 
    `<span class="font-bold">${scenarioData.solution}.</span> ${translations[resultStrategyKey][lang]}`;
    
    strategyList.innerHTML = scenarioData.strategy.map(item => `<li>${item}</li>`).join('');
    
    document.getElementById('game-area').classList.add('hidden'); // Hide game area after checking
};

window.resetGame = () => {
    window.currentScenarioId = null;
    document.getElementById('scenario-selection').classList.remove('hidden');
    document.getElementById('game-area').classList.add('hidden');
    document.getElementById('result-feedback').classList.add('hidden');
    document.getElementById('current-scenario-display').classList.add('hidden');
    window.resetGameArea();
};

// --- DRAG AND DROP HANDLERS ---
window.dragStart = (e) => {
    e.dataTransfer.setData('text/plain', e.target.id);
    e.target.style.opacity = '0.5';
};

window.dragEnter = (e) => {
    e.preventDefault();
    if (e.target.classList.contains('drop-zone')) {
    e.target.classList.add('active');
    }
};

window.dragOver = (e) => {
    e.preventDefault();
};

window.dragLeave = (e) => {
    if (e.target.classList.contains('drop-zone')) {
    e.target.classList.remove('active');
    }
};

const updateCheckButtonState = () => {
    const defenseCards = document.getElementById('defense-zone').querySelectorAll('.card').length;
    const limitCards = document.getElementById('limit-zone').querySelectorAll('.card').length;
    
    // Enable check button if at least one card is in one of the zones
    const isReady = defenseCards > 0 || limitCards > 0;
    document.getElementById('check-button').disabled = !isReady;
};

window.drop = (e) => {
    e.preventDefault();
    const data = e.dataTransfer.getData('text/plain');
    const draggedElement = document.getElementById(data);
    const dropZone = e.target.closest('.drop-zone');

    if (draggedElement && dropZone) {
    dropZone.classList.remove('active');

    // Remove existing hint if it exists
    const hint = dropZone.querySelector('p');
    if (hint) hint.classList.add('hidden');

    // Determine which style class to use
    draggedElement.classList.remove('defense-card', 'limit-card');

    if (dropZone.id === 'defense-zone') {
    draggedElement.classList.add('defense-card');
    } else if (dropZone.id === 'limit-zone') {
    draggedElement.classList.add('limit-card');
    }

    dropZone.appendChild(draggedElement);
    draggedElement.style.opacity = '1';

    updateCheckButtonState();
    } else if (e.target.id === 'concept-cards' || e.target.closest('#concept-cards')) {
    // If dropped back into the source area
    const sourceZone = document.getElementById('concept-cards');
    sourceZone.appendChild(draggedElement);
    draggedElement.classList.remove('defense-card', 'limit-card');
    draggedElement.style.opacity = '1';
    updateCheckButtonState();
    }
};

// --- INITIALIZATION ---
window.addEventListener('firebaseReady', () => {
    console.log("Firebase is ready and authenticated.");
});

document.addEventListener('DOMContentLoaded', () => {
    setupFirebaseAndAuth();

    // Setup drag & drop listeners on zones
    const zones = document.querySelectorAll('.drop-zone, #concept-cards');
    zones.forEach(zone => {
    zone.addEventListener('dragover', window.dragOver);
    zone.addEventListener('dragenter', window.dragEnter);
    zone.addEventListener('dragleave', window.dragLeave);
    zone.addEventListener('drop', window.drop);
    });

    // Initial UI setup
    window.showLoginForm('eu');
});
</script>
</body>
</html>
